<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Precificação - HS</title>

  <style>
    :root{
      --bg:#000;
      --panel:#141414;
      --panel2:#101010;
      --line:#2a2a2a;
      --muted:#bdbdbd;
      --pri:#673ab7;
      --pri2:#7b4ef0;
      --ok:#28a745;
      --warn:#e67e22;
      --err:#e53935;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:22px}
    h1{margin:0 0 14px;font-size:20px;font-weight:800}
    .grid{display:grid;gap:14px}
    .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1f1f1f;padding:14px;border-radius:12px}
    .section-title{margin:0 0 10px;font-weight:800}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:#ddd}
    input,select,button,textarea{
      padding:10px 12px;border-radius:10px;border:1px solid #333;background:#0e0e0e;color:#fff;outline:none
    }
    textarea{width:100%;min-height:140px;resize:vertical;line-height:1.35}
    select{cursor:pointer}
    button{background:var(--pri);border:0;cursor:pointer;font-weight:800;transition:.12s transform ease, .12s background ease}
    button:hover{background:var(--pri2);transform:translateY(-1px)}
    button.secondary{background:#2a2a2a}
    button.secondary:hover{background:#363636}
    button:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .muted{color:var(--muted);font-size:12px}
    .right{margin-left:auto}
    .pill{background:#0e0e0e;border:1px solid #222;padding:8px 10px;border-radius:10px;display:inline-flex;gap:8px;align-items:center;font-size:12px}
    .pill strong{font-size:13px}
    .scroll{max-height:520px;overflow:auto;border:1px solid #242424;border-radius:12px;margin-top:10px}
    table{border-collapse:separate;border-spacing:0;width:100%;min-width:900px}
    th,td{padding:10px 10px;border-bottom:1px solid #1f1f1f;font-size:13px;white-space:nowrap;vertical-align:middle}
    th{background:#0f0f0f;position:sticky;top:0;z-index:5;text-align:left;border-bottom:1px solid #2b2b2b}
    th:first-child, td:first-child{position:sticky;left:0;z-index:6;background:#121212;border-right:1px solid #222;font-weight:800}
    th:first-child{z-index:10;background:#101010}
    th.draggable{cursor:grab;user-select:none}
    th.draggable:active{cursor:grabbing}
    th.drag-over{outline:2px dashed rgba(123,78,240,.85);outline-offset:-4px}
    th.dragging{opacity:.55}
  </style>
</head>

<body>
  <div class="wrap grid">
    <h1>Precificação — HS</h1>

    <!-- INCLUIR NOVA COLEÇÃO -->
    <div class="panel">
      <div class="section-title">Incluir nova coleção (lista de preço)</div>

      <div class="row">
        <label>Nome da coleção</label>
        <input id="newCollName" placeholder="Ex.: OUTONO 25 REM 2" style="min-width:320px;text-transform:uppercase"/>
        <button id="btnAddCollection">Salvar coleção no banco</button>
        <span class="muted right" id="addStatus"></span>
      </div>

      <div class="muted" style="margin-top:8px">
        Cole aqui os itens, 1 por linha. Aceita: <b>REF;PREÇO</b> ou <b>REF,PREÇO</b> ou <b>REF PREÇO</b>.
      </div>
      <div style="margin-top:10px">
        <textarea id="newCollItems" placeholder="Ex:
0227;89,99
2441406;159,00
..."></textarea>
      </div>
    </div>

    <!-- GRAVAR COLEÇÃO ATUAL (EXPORT) -->
    <div class="panel">
      <div class="section-title">Gravar Coleção Atual (aba Leonardo)</div>

      <div class="row">
        <label>Gerar lista “até”</label>
        <select id="exportBase">
          <option value="">ÚLTIMA (padrão)</option>
        </select>

        <label>Senha</label>
        <input id="exportPass" type="password" placeholder="Senha" style="width:180px"/>

        <button id="btnExport">Gravar COLEÇÃO ATUAL</button>
        <span class="muted right" id="exportStatus"></span>
      </div>

      <div class="muted" style="margin-top:8px">
        Isso sobrescreve a aba <b>Leonardo</b> nas colunas A:B e coloca <b>COLEÇÃO ATUAL</b> na coluna C.
      </div>
    </div>

    <!-- BUSCA POR REFERÊNCIA -->
    <div class="panel">
      <div class="section-title">Buscar referência</div>
      <div class="row">
        <label>Referência</label>
        <input id="refInput" placeholder="Ex.: 0227" style="min-width:180px;text-transform:uppercase"/>
        <button id="btnBuscarRef">Buscar</button>
        <span id="refStatus" class="muted right"></span>
      </div>

      <div class="row" id="refResumo" style="margin-top:10px;display:none;flex-wrap:wrap">
        <span class="pill">Maior preço (histórico): <strong id="refMax"></strong></span>
        <span class="pill">Coleção(ões) do maior preço: <strong id="refMaxCols"></strong></span>
        <span class="pill">Preço atual (última coleção): <strong id="refAtualPreco"></strong></span>
        <span class="pill">Coleção atual: <strong id="refAtualCol"></strong></span>
      </div>

      <div id="refTabelaWrap"></div>
    </div>

    <!-- COMPARAR COLEÇÕES -->
    <div class="panel">
      <div class="section-title">Comparar coleções</div>
      <div class="row">
        <label>Coleção A</label>
        <select id="collA"></select>
        <label>Coleção B</label>
        <select id="collB"></select>
        <button id="btnComparar">Comparar</button>

        <button id="btnSomenteAlterou" class="secondary">Somente alterou</button>
        <button id="btnSomenteSubiu" class="secondary">Somente subiu</button>
        <button id="btnSomenteDesceu" class="secondary">Somente desceu</button>

        <span id="cmpStatus" class="muted right"></span>
      </div>
      <div id="cmpTabelaWrap"></div>
    </div>

    <!-- MATRIZ -->
    <div class="panel">
      <div class="section-title">Tabela preços x coleções (Matriz)</div>
      <div class="row">
        <label>Limitar primeiras N referências (opcional)</label>
        <input id="matLimit" type="number" min="1" style="width:140px" placeholder="ex.: 200"/>
        <label>Filtrar referência</label>
        <input id="matSearch" placeholder="Ex.: 0227" style="width:200px;text-transform:uppercase"/>
        <button id="btnMatriz">Gerar TABELA</button>
        <button id="btnResetOrdem" class="secondary" disabled>Resetar ordem</button>
        <span id="matStatus" class="muted right"></span>
      </div>

      <div class="muted" style="margin-top:8px">
        Arraste o nome da coleção no cabeçalho para reorganizar. A coluna <b>REF</b> fica fixa. A ordem fica salva neste navegador.
      </div>

      <div id="matTabelaWrap"></div>
    </div>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyFVqDrgXkYThp03XT3xB3Bi0fK3hW-956TIkOmZyb4guFElY4kZYzksy2v2jB3mzWB/exec";

    const fmtBR = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(n||0));
    const safe = (s)=> String(s ?? "");
    const LS_KEY_COL_ORDER = "HS_PRECO_COL_ORDER_v1";

    let matrizState = null;
    let cmpOnlyChanged=false, cmpOnlyUp=false, cmpOnlyDown=false;

    async function api(action, params={}) {
      const url = new URL(API_URL);
      url.search = new URLSearchParams({ action, ...params }).toString();
      const res = await fetch(url);
      return res.json();
    }

    async function post(payload){
      const res = await fetch(API_URL,{ method:"POST", body: JSON.stringify(payload) });
      return res.json();
    }

    function renderTable(targetId, head, rows){
      const wrap=document.getElementById(targetId);
      wrap.innerHTML='';
      const table=document.createElement('table');
      table.innerHTML = `
        <thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
        <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
      const scroll=document.createElement('div');
      scroll.className='scroll';
      scroll.appendChild(table);
      wrap.appendChild(scroll);
    }

    function normalizeRef(v){ return safe(v).trim().toUpperCase(); }

    function loadLocalOrder(){
      try{
        const raw = localStorage.getItem(LS_KEY_COL_ORDER);
        if(!raw) return null;
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : null;
      }catch(e){ return null; }
    }
    function saveLocalOrder(order){ localStorage.setItem(LS_KEY_COL_ORDER, JSON.stringify(order)); }
    function clearLocalOrder(){ localStorage.removeItem(LS_KEY_COL_ORDER); }

    function applyOrderToMatrix(originalColls, desiredOrder){
      const set = new Set(originalColls);
      const cleaned = (desiredOrder || []).filter(c => set.has(c));
      const remaining = originalColls.filter(c => !cleaned.includes(c));
      return cleaned.concat(remaining);
    }

    function buildMatrixView(state){
      const head = ["REF"].concat(state.order);
      const rows = state.refs.map(ref => {
        const line = [ref];
        state.order.forEach(c => {
          const v = state.priceIndex[ref + "||" + c];
          line.push(v == null ? "-" : fmtBR(v));
        });
        return line;
      });
      return { head, rows };
    }

    function renderMatrix(state){
      const wrap = document.getElementById('matTabelaWrap');
      wrap.innerHTML = '';

      const view = buildMatrixView(state);
      const table = document.createElement('table');

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      view.head.forEach((h, idx) => {
        const th = document.createElement('th');
        th.textContent = h;
        if(idx > 0){
          th.classList.add('draggable');
          th.setAttribute('draggable','true');
          th.dataset.col = h;
        }
        trh.appendChild(th);
      });

      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      view.rows.forEach(r=>{
        const tr=document.createElement('tr');
        r.forEach(cell=>{
          const td=document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);

      const scroll = document.createElement('div');
      scroll.className = 'scroll';
      scroll.appendChild(table);
      wrap.appendChild(scroll);

      enableMatrixDrag(table, state);
      document.getElementById('btnResetOrdem').disabled = false;
    }

    function enableMatrixDrag(table, state){
      let dragCol = null;
      const ths = table.querySelectorAll('thead th.draggable');

      ths.forEach(th=>{
        th.addEventListener('dragstart', (ev)=>{
          dragCol = th.dataset.col;
          th.classList.add('dragging');
          ev.dataTransfer.effectAllowed = "move";
        });
        th.addEventListener('dragend', ()=>{
          th.classList.remove('dragging');
          ths.forEach(x=>x.classList.remove('drag-over'));
          dragCol=null;
        });
        th.addEventListener('dragover', (ev)=>{
          ev.preventDefault();
          th.classList.add('drag-over');
        });
        th.addEventListener('dragleave', ()=> th.classList.remove('drag-over'));
        th.addEventListener('drop', (ev)=>{
          ev.preventDefault();
          th.classList.remove('drag-over');

          const dropCol = th.dataset.col;
          if(!dragCol || !dropCol || dragCol===dropCol) return;

          const order = state.order.slice();
          const from = order.indexOf(dragCol);
          const to   = order.indexOf(dropCol);
          if(from===-1 || to===-1) return;

          order.splice(from,1);
          order.splice(to,0,dragCol);

          state.order = order;
          saveLocalOrder(order);
          renderMatrix(state);
        });
      });
    }

    async function loadCollections(){
      const colls = await api("listCollections");

      const fill=(sel)=>{
        sel.innerHTML = '<option value="">Selecione</option>';
        colls.forEach(c=>{
          const o=document.createElement('option');
          o.value=o.textContent=c;
          sel.appendChild(o);
        });
      };

      fill(document.getElementById('collA'));
      fill(document.getElementById('collB'));

      // export base
      const baseSel = document.getElementById('exportBase');
      baseSel.innerHTML = '<option value="">ÚLTIMA (padrão)</option>';
      colls.forEach(c=>{
        const o=document.createElement('option');
        o.value=o.textContent=c;
        baseSel.appendChild(o);
      });
    }

    // ========= INCLUIR COLEÇÃO =========
    function parseItemsText(text){
      const lines = safe(text).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const items = [];
      lines.forEach(line=>{
        // separadores: ; , espaço
        let parts = line.split(";");
        if(parts.length < 2) parts = line.split(",");
        if(parts.length < 2) parts = line.split(/\s+/);

        const ref = normalizeRef(parts[0] || "");
        const price = safe(parts[1] || "").trim();
        if(ref && price) items.push({ ref, price });
      });
      return items;
    }

    document.getElementById('btnAddCollection').onclick = async ()=>{
      const name = normalizeRef(document.getElementById('newCollName').value);
      const items = parseItemsText(document.getElementById('newCollItems').value);
      const st = document.getElementById('addStatus');

      if(!name){ alert("Digite o nome da coleção."); return; }
      if(!items.length){ alert("Cole os itens e preços."); return; }

      st.textContent = "Salvando...";
      const resp = await post({ action:"addCollection", name, items });
      st.textContent = "";

      if(resp.status==="ok"){
        alert("Coleção salva: " + resp.colecao + " (" + resp.inserted + " itens)");
        document.getElementById('newCollItems').value = "";
        await loadCollections(); // atualiza combos
      }else{
        alert("Erro: " + (resp.erro || "desconhecido"));
      }
    };

    // ========= EXPORT COLEÇÃO ATUAL =========
    document.getElementById('btnExport').onclick = async ()=>{
      const base = document.getElementById('exportBase').value;
      const pass = document.getElementById('exportPass').value;
      const st = document.getElementById('exportStatus');

      if(!pass){ alert("Digite a senha."); return; }

      st.textContent = "Gravando...";
      const resp = await post({ action:"exportCurrentPrices", password: pass, baseCollection: base });
      st.textContent = "";

      if(resp.status==="ok"){
        alert("OK! Exportado: " + resp.exported + " refs (cutoff: " + resp.cutoff + ")");
        document.getElementById('exportPass').value = "";
      }else{
        alert("Erro: " + (resp.erro || "desconhecido"));
      }
    };

    // ========= BUSCAR REF =========
    document.getElementById('btnBuscarRef').onclick = async ()=>{
      const ref = normalizeRef(document.getElementById('refInput').value);
      const status = document.getElementById('refStatus');
      status.textContent = "Buscando...";

      const res = await api("searchReference",{ ref });
      status.textContent = "";

      const wrap = document.getElementById('refTabelaWrap');
      wrap.innerHTML = "";

      if(!res.items || !res.items.length){
        document.getElementById('refResumo').style.display = "none";
        wrap.innerHTML = '<div class="muted" style="margin-top:10px">Nenhum dado encontrado.</div>';
        return;
      }

      document.getElementById('refMax').textContent = fmtBR(res.max);
      document.getElementById('refMaxCols').textContent = (res.maxCollections||[]).join(", ");
      document.getElementById('refAtualPreco').textContent = res.atual ? fmtBR(res.atual.preco) : "-";
      document.getElementById('refAtualCol').textContent = res.atual ? safe(res.atual.colecao) : "-";
      document.getElementById('refResumo').style.display = "flex";

      const rows = res.items.map(i=> [safe(i.coll), fmtBR(i.price)]);
      renderTable("refTabelaWrap", ["Coleção","Preço"], rows);
    };

    // ========= COMPARAR =========
    function applyCompareFilters(list){
      let data = list || [];
      if(cmpOnlyChanged) data = data.filter(r=> r.alterou);
      if(cmpOnlyUp) data = data.filter(r=> r.direcao==="SUBIU");
      if(cmpOnlyDown) data = data.filter(r=> r.direcao==="DESCEU");
      return data;
    }

    async function doCompare(){
      const a = document.getElementById('collA').value;
      const b = document.getElementById('collB').value;
      if(!a || !b){ alert("Selecione Coleção A e B"); return; }

      document.getElementById('cmpStatus').textContent = "Comparando...";
      const list = await api("compareCollections",{ a, b });
      document.getElementById('cmpStatus').textContent = "";

      const data = applyCompareFilters(list);

      const body = data.map(r=>[
        safe(r.referencia),
        r.precoA==null ? "-" : fmtBR(r.precoA),
        r.precoB==null ? "-" : fmtBR(r.precoB),
        r.delta==null ? "-" : fmtBR(r.delta),
        safe(r.direcao)
      ]);

      renderTable("cmpTabelaWrap", ["REF",`Preço (${a})`,`Preço (${b})`,"Δ","Status"], body);
    }

    document.getElementById('btnComparar').onclick = doCompare;
    document.getElementById('btnSomenteAlterou').onclick = ()=>{ cmpOnlyChanged=!cmpOnlyChanged; cmpOnlyUp=false; cmpOnlyDown=false; doCompare(); };
    document.getElementById('btnSomenteSubiu').onclick   = ()=>{ cmpOnlyUp=!cmpOnlyUp; cmpOnlyChanged=false; cmpOnlyDown=false; doCompare(); };
    document.getElementById('btnSomenteDesceu').onclick  = ()=>{ cmpOnlyDown=!cmpOnlyDown; cmpOnlyChanged=false; cmpOnlyUp=false; doCompare(); };

    // ========= MATRIZ =========
    document.getElementById('btnMatriz').onclick = async ()=>{
      const limit = document.getElementById('matLimit').value;
      document.getElementById('matStatus').textContent = "Gerando...";

      const obj = await api("matrix",{ limit });
      document.getElementById('matStatus').textContent = "";

      if(!obj || !obj.rows || !obj.rows.length){
        document.getElementById('matTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Sem dados.</div>';
        document.getElementById('btnResetOrdem').disabled = true;
        matrizState = null;
        return;
      }

      const colls = obj.header.slice(1);
      const refs  = obj.rows.map(r=>r[0]);

      const priceIndex = Object.create(null);
      obj.rows.forEach(r=>{
        const ref = safe(r[0]);
        for(let i=1;i<obj.header.length;i++){
          const coll = obj.header[i];
          const v = r[i];
          if(v != null && v !== "") priceIndex[ref + "||" + coll] = v;
        }
      });

      const stored = loadLocalOrder();
      const order = applyOrderToMatrix(colls, stored);

      matrizState = { refs, colls, order, priceIndex };
      renderMatrix(matrizState);

      // filtro em tempo real
      const input = document.getElementById('matSearch');
      input.oninput = ()=>{
        const term = normalizeRef(input.value);
        if(!matrizState) return;
        const wrap = document.getElementById('matTabelaWrap');
        const trs = wrap.querySelectorAll('tbody tr');
        trs.forEach(tr=>{
          const ref = normalizeRef(tr.querySelector('td')?.textContent || "");
          tr.style.display = term && !ref.includes(term) ? "none" : "";
        });
      };
    };

    document.getElementById('btnResetOrdem').onclick = ()=>{
      if(!matrizState) return;
      if(!confirm("Resetar ordem das colunas para o padrão?")) return;
      clearLocalOrder();
      matrizState.order = matrizState.colls.slice();
      renderMatrix(matrizState);
    };

    // init
    loadCollections();
  </script>
</body>
</html>
