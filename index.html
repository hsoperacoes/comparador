<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Precificação - HS</title>
  <style>
    :root { --bg:#111; --panel:#1c1c1c; --muted:#bdbdbd; --pri:#673ab7; --ok:#28a745; --warn:#e67e22; --err:#e53935; }
    *{box-sizing:border-box} body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#000;color:#fff}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{margin:0 0 18px;font-size:22px}
    .grid{display:grid;gap:16px}
    .panel{background:var(--panel);padding:16px;border-radius:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:#ddd}
    input,select,button{padding:10px 12px;border-radius:8px;border:1px solid #333;background:#121212;color:#fff}
    button{background:var(--pri);border:0;cursor:pointer;font-weight:600}
    button.secondary{background:#2f2f2f}
    button:disabled{opacity:.6;cursor:not-allowed}
    table{border-collapse:collapse;min-width:100%}
    th,td{padding:8px 10px;border-bottom:1px solid #2c2c2c;font-size:14px;white-space:nowrap}
    th{background:#151515;text-align:left}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px}
    .ok{background:rgba(40,167,69,.15);color:#6fe18b}
    .warn{background:rgba(230,126,34,.15);color:#f8b37a}
    .err{background:rgba(229,57,53,.15);color:#ff9a9a}
    .muted{color:var(--muted);font-size:12px}
    .pill{background:#222;padding:6px 10px;border-radius:8px}
    .section-title{margin:4px 0 10px;font-weight:700}
    .right{margin-left:auto}
    /* SCROLL COM FIXO */
    .scroll {max-height:500px; overflow:auto; border:1px solid #333; margin-top:10px;}
    .scroll table th {
      position: sticky;
      top: 0;
      background: #151515;
      z-index: 2;
    }
    .scroll table td:first-child,
    .scroll table th:first-child {
      position: sticky;
      left: 0;
      background: #1c1c1c;
      z-index: 3;
    }
  </style>
</head>
<body>
  <div class="wrap grid">

    <h1>Precificação — HS</h1>

    <!-- BUSCA POR REFERÊNCIA -->
    <div class="panel">
      <div class="section-title">Buscar referência</div>
      <div class="row">
        <label>Referência</label>
        <input id="refInput" placeholder="Ex.: 2441406" style="min-width:200px"/>
        <button id="btnBuscarRef">Buscar</button>
        <button id="btnIncluir" class="secondary">Incluir na lista</button>
        <button id="btnFinalizar" class="secondary">Finalizar lista</button>
        <span id="refStatus" class="muted"></span>
      </div>
      <div id="refResumo" class="row" style="margin-top:10px;display:none">
        <span class="pill">Maior preço: <strong id="refMax"></strong></span>
        <span class="pill">Coleção(ões) do maior preço: <strong id="refMaxCols"></strong></span>
      </div>
      <div id="refTabelaWrap"></div>
    </div>

    <!-- COMPARAR COLEÇÕES -->
    <div class="panel">
      <div class="section-title">Comparar coleções</div>
      <div class="row">
        <label>Coleção A</label>
        <select id="collA"></select>
        <label>Coleção B</label>
        <select id="collB"></select>
        <button id="btnComparar">Comparar</button>
        <button id="btnSomenteAlterou" class="secondary">Mostrar apenas “Alterou”</button>
        <span id="cmpStatus" class="muted right"></span>
      </div>
      <div id="cmpTabelaWrap"></div>
    </div>

    <!-- MAX POR REFERÊNCIA -->
    <div class="panel">
      <div class="section-title">Maior preço por referência</div>
      <div class="row">
        <label>Filtrar coleção</label>
        <select id="maxColl"></select>
        <button id="btnMax">Gerar/Atualizar</button>
        <span class="muted">Lista as referências com maior preço (todas ou só da coleção escolhida).</span>
      </div>
      <div id="maxTabelaWrap"></div>
    </div>

    <!-- MATRIZ PREÇOS x COLEÇÕES -->
    <div class="panel">
      <div class="section-title">Tabela preços x coleções</div>
      <div class="row">
        <label>Limitar primeiras N referências (opcional)</label>
        <input id="matLimit" type="number" min="1" style="width:120px" placeholder="ex.: 200"/>
        <label>Filtrar referência</label>
        <input id="matSearch" placeholder="Ex.: 2441406" style="width:200px"/>
        <button id="btnMatriz">Gerar TABELA</button>
        <span id="matStatus" class="muted right"></span>
      </div>
      <div id="matTabelaWrap"></div>
    </div>

  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbyFVqDrgXkYThp03XT3xB3Bi0fK3hW-956TIkOmZyb4guFElY4kZYzksy2v2jB3mzWB/exec";
    const fmtBR = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);
    let listaTemp=[];

    async function api(path, params={}) {
      const url=new URL(API_URL);
      url.search=new URLSearchParams({action:path,...params}).toString();
      const res=await fetch(url);
      return res.json();
    }
    async function postData(payload){
      const res=await fetch(API_URL,{method:'POST',body:JSON.stringify(payload)});
      return res.json();
    }

    function renderTable(containerId, head, rows){
      const wrap=document.getElementById(containerId);
      wrap.innerHTML='';
      const table=document.createElement('table');
      table.innerHTML=`<thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
                       <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>`;
      const scroll=document.createElement('div');
      scroll.className='scroll';
      scroll.appendChild(table);
      wrap.appendChild(scroll);
    }

    async function loadCollections(){
      const colls=await api("listCollections");
      const fill=(sel)=>{sel.innerHTML='<option value="">Todas</option>';colls.forEach(c=>{const o=document.createElement('option');o.value=o.textContent=c;sel.appendChild(o);});};
      fill(document.getElementById('collA'));
      fill(document.getElementById('collB'));
      fill(document.getElementById('maxColl'));
    }

    // buscar ref
    document.getElementById('btnBuscarRef').onclick=async ()=>{
      const ref=document.getElementById('refInput').value.trim().toUpperCase();
      const status=document.getElementById('refStatus');status.textContent='Buscando...';
      const res=await api("searchReference",{ref});
      status.textContent='';
      if(!res.items||!res.items.length){document.getElementById('refTabelaWrap').innerHTML='<div class="muted">Nenhum dado encontrado.</div>';return;}
      document.getElementById('refMax').textContent=fmtBR(res.max);
      document.getElementById('refMaxCols').textContent=res.maxCollections.join(', ');
      document.getElementById('refResumo').style.display='flex';
      const rows=res.items.map(i=>[i.coll,fmtBR(i.price)]);
      renderTable('refTabelaWrap',["Coleção","Preço"],rows);
    };

    // incluir/finalizar lista
    document.getElementById('btnIncluir').onclick=async ()=>{
      const ref=document.getElementById('refInput').value.trim().toUpperCase();
      if(!ref)return;
      const res=await api("searchReference",{ref});
      if(res.items&&res.items.length){res.items.forEach(i=>listaTemp.push({ref:ref,coll:i.coll,price:i.price}));alert("Adicionado: "+ref);}
    };
    document.getElementById('btnFinalizar').onclick=async ()=>{
      if(!listaTemp.length){alert("Lista vazia.");return;}
      const resp=await postData({items:listaTemp});
      if(resp.status==="ok"){alert("Enviado "+resp.enviados+" itens.");listaTemp=[];}
    };

    // comparar coleções
    let cmpOnlyChanged=false;
    document.getElementById('btnSomenteAlterou').onclick=()=>{cmpOnlyChanged=!cmpOnlyChanged;document.getElementById('btnComparar').click();};
    document.getElementById('btnComparar').onclick=async ()=>{
      const a=document.getElementById('collA').value;
      const b=document.getElementById('collB').value;
      const rows=await api("compareCollections",{a,b});
      let data=rows||[];if(cmpOnlyChanged)data=data.filter(r=>r.alterou);
      const body=data.map(r=>[r.referencia,r.precoA==null?'-':fmtBR(r.precoA),r.precoB==null?'-':fmtBR(r.precoB),r.delta==null?'-':fmtBR(r.delta),r.deltaPct==null?'-':(r.deltaPct*100).toFixed(2)+'%',r.alterou?'<span class="badge warn">SIM</span>':'<span class="badge ok">NÃO</span>']);
      renderTable('cmpTabelaWrap',["Referência",`Preço (${a})`,`Preço (${b})`,"Δ","Δ %","Alterou?"],body);
    };

    // max
    document.getElementById('btnMax').onclick=async ()=>{
      const coll=document.getElementById('maxColl').value;
      const list=await api("maxByReference",{colecao:coll});
      if(!list.length){document.getElementById('maxTabelaWrap').innerHTML='<div class="muted">Sem dados.</div>';return;}
      const rows=list.map(r=>[r.referencia,fmtBR(r.max)]);
      renderTable('maxTabelaWrap',["Referência","MAX de valor"],rows);
    };

    // matriz
    document.getElementById('btnMatriz').onclick=async ()=>{
      const limit=document.getElementById('matLimit').value;
      const obj=await api("matrix",{limit});
      if(!obj.rows.length){document.getElementById('matTabelaWrap').innerHTML='<div class="muted">Sem dados.</div>';return;}
      const rows=obj.rows.map(r=>r.map((v,i)=>i===0?v:(v==null?'-':fmtBR(v))));
      renderTable('matTabelaWrap',obj.header,rows);
      document.getElementById('matSearch').oninput=()=>{
        const term=document.getElementById('matSearch').value.trim().toLowerCase();
        const trs=document.querySelectorAll('#matTabelaWrap tbody tr');
        trs.forEach(tr=>{const ref=tr.querySelector('td')?.textContent.toLowerCase()||"";tr.style.display=term&&!ref.includes(term)?"none":"";});
      };
    };

    loadCollections();
  </script>
</body>
</html>
