<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Precificação — HS</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#000;
  --panel:#1c1c1c;
  --line:#2a2a2a;
  --pri:#673ab7;
  --ok:#2ecc71;
  --down:#e74c3c;
  --same:#f1c40f;
  --txt:#fff;
  --muted:#aaa;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--txt);
  font-family:Segoe UI,Arial,sans-serif;
}

.wrap{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

h1{
  margin:0 0 16px;
  font-size:22px;
}

.panel{
  background:var(--panel);
  border-radius:10px;
  padding:16px;
  margin-bottom:16px;
}

.section-title{
  font-weight:700;
  margin-bottom:10px;
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

input,select,textarea,button{
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:8px;
  padding:10px;
}

textarea{
  width:100%;
  min-height:120px;
  font-family:monospace;
}

button{
  background:var(--pri);
  border:0;
  cursor:pointer;
  font-weight:600;
}

button.secondary{background:#333}
button:disabled{opacity:.6}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}

th,td{
  padding:8px 10px;
  border-bottom:1px solid var(--line);
  white-space:nowrap;
}

th{
  background:#141414;
  position:sticky;
  top:0;
}

.scroll{
  max-height:420px;
  overflow:auto;
  border:1px solid #333;
  border-radius:8px;
}

.badge{
  padding:3px 8px;
  border-radius:999px;
  font-size:12px;
  font-weight:600;
}

.up{background:rgba(46,204,113,.15);color:var(--ok)}
.down{background:rgba(231,76,60,.15);color:var(--down)}
.same{background:rgba(241,196,15,.15);color:var(--same)}

.muted{color:var(--muted);font-size:12px}
.right{margin-left:auto}
</style>
</head>

<body>
<div class="wrap">

<h1>Precificação — HS</h1>

<!-- NOVA COLEÇÃO -->
<div class="panel">
  <div class="section-title">Nova coleção</div>

  <div class="row">
    <label>Nome da coleção</label>
    <input id="colecaoNome" placeholder="Ex: ALTO VERÃO 2025 REM" style="min-width:260px">
  </div>

  <div class="row" style="margin-top:10px">
    <label>Itens (cole do Excel)</label>
  </div>

  <textarea id="colecaoItens" placeholder="REF<TAB>PREÇO ou REF;PREÇO"></textarea>

  <div class="row" style="margin-top:10px">
    <button onclick="salvarColecao()">Salvar coleção</button>
    <span id="statusNova" class="muted"></span>
  </div>
</div>

<!-- COMPARAR COLEÇÕES -->
<div class="panel">
  <div class="section-title">Comparar coleções</div>

  <div class="row">
    <label>Coleção A</label>
    <select id="collA"></select>

    <label>Coleção B</label>
    <select id="collB"></select>

    <button onclick="comparar()">Comparar</button>
    <span id="cmpStatus" class="muted right"></span>
  </div>

  <div class="scroll">
    <table id="cmpTable"></table>
  </div>
</div>

</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyFVqDrgXkYThp03XT3xB3Bi0fK3hW-956TIkOmZyb4guFElY4kZYzksy2v2jB3mzWB/exec";

const fmt = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n);

async function apiGet(params){
  const url = API_URL + "?" + new URLSearchParams(params).toString();
  const r = await fetch(url);
  return r.json();
}

async function apiPost(payload){
  const r = await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
  return r.json();
}

/* ========= LOAD INICIAL ========= */
async function loadCollections(){
  const colls = await apiGet({action:"listCollections"});
  const a = document.getElementById("collA");
  const b = document.getElementById("collB");
  a.innerHTML = "";
  b.innerHTML = "";
  colls.forEach(c=>{
    a.add(new Option(c,c));
    b.add(new Option(c,c));
  });
}
loadCollections();

/* ========= SALVAR COLEÇÃO ========= */
async function salvarColecao(){
  const nome = document.getElementById("colecaoNome").value.trim();
  const txt  = document.getElementById("colecaoItens").value.trim();
  const status = document.getElementById("statusNova");

  if(!nome || !txt){
    alert("Informe nome da coleção e itens.");
    return;
  }

  const items = txt.split("\n").map(l=>{
    let [r,p] = l.includes(";") ? l.split(";") : l.split("\t");
    return {ref:r?.trim(), preco:p?.trim()};
  }).filter(i=>i.ref && i.preco);

  status.textContent = "Salvando...";

  const res = await apiPost({
    action:"addCollection",
    colecaoNome:nome,
    items
  });

  if(res.status==="ok"){
    status.textContent = `OK — gravada como "${res.colecao}" (${res.inseridos} itens)`;
    document.getElementById("colecaoItens").value="";
    loadCollections();
  }else{
    status.textContent = "Erro: "+(res.erro||"");
  }
}

/* ========= COMPARAR ========= */
async function comparar(){
  const A = document.getElementById("collA").value;
  const B = document.getElementById("collB").value;
  const tbl = document.getElementById("cmpTable");
  tbl.innerHTML = "<tr><td class='muted'>Carregando...</td></tr>";

  const rows = await apiGet({action:"compareCollections",a:A,b:B});
  if(!rows.length){
    tbl.innerHTML = "<tr><td class='muted'>Sem dados</td></tr>";
    return;
  }

  tbl.innerHTML = `
    <tr>
      <th>REF</th>
      <th>${A}</th>
      <th>${B}</th>
      <th>Δ</th>
      <th>Status</th>
    </tr>
  `;

  rows.forEach(r=>{
    let badge="same",label="IGUAL";
    if(r.direcao==="SUBIU"){badge="up";label="SUBIU";}
    if(r.direcao==="DESCEU"){badge="down";label="DESCEU";}

    tbl.innerHTML += `
      <tr>
        <td>${r.referencia}</td>
        <td>${r.precoA==null?"-":fmt(r.precoA)}</td>
        <td>${r.precoB==null?"-":fmt(r.precoB)}</td>
        <td>${r.delta==null?"-":fmt(r.delta)}</td>
        <td><span class="badge ${badge}">${label}</span></td>
      </tr>
    `;
  });
}
</script>

</body>
</html>
