<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Precificação — HS</title>
  <style>
    :root{
      --bg:#0b0b0c;
      --panel:#151517;
      --panel2:#111114;
      --line:#2a2a2f;
      --muted:#b9b9c2;
      --txt:#ffffff;
      --pri:#6f3ccf;
      --pri2:#532aa0;
      --ok:#2ecc71;
      --warn:#f39c12;
      --err:#e74c3c;
      --chip:#22222a;
      --shadow: 0 10px 30px rgba(0,0,0,.45);
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: Inter, Segoe UI, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(111,60,207,.25), transparent 60%),
                  radial-gradient(900px 600px at 90% 0%, rgba(46,204,113,.12), transparent 55%),
                  var(--bg);
      color:var(--txt);
      min-height:100vh;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:26px 18px 60px}
    h1{margin:0 0 18px;font-size:22px;font-weight:800;letter-spacing:.2px}
    .grid{display:grid;gap:16px}
    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 80%), var(--panel);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow);
      border-radius:var(--radius);
      padding:16px;
    }
    .panel .title{
      display:flex;align-items:center;gap:10px;
      font-weight:800;
      margin:0 0 10px;
    }
    .title small{font-weight:600;color:var(--muted);opacity:.9}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:12px;color:var(--muted)}
    input,select,textarea,button{
      border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.35);
      color:var(--txt);
      padding:10px 12px;
      outline:none;
    }
    input::placeholder, textarea::placeholder{color:#8e8ea0}
    textarea{width:100%;min-height:140px;resize:vertical;line-height:1.35}
    button{
      background: linear-gradient(180deg, var(--pri), var(--pri2));
      border:none;
      font-weight:800;
      cursor:pointer;
      padding:10px 14px;
      transition:.15s transform, .15s opacity;
    }
    button:active{transform:scale(.98)}
    button.secondary{
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      font-weight:700;
    }
    button.danger{
      background: rgba(231,76,60,.18);
      border:1px solid rgba(231,76,60,.35);
      color:#ffd6d1;
    }
    button.success{
      background: rgba(46,204,113,.18);
      border:1px solid rgba(46,204,113,.35);
      color:#d4f5e0;
    }
    button:disabled{opacity:.55;cursor:not-allowed}
    .hint{color:var(--muted);font-size:12px}
    .chips{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .chip{
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.08);
      padding:8px 10px;border-radius:12px;
      font-size:13px;color:#f0f0f6;
    }
    .chip strong{font-weight:900}
    .split{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px}
    @media(max-width:980px){.split{grid-template-columns:1fr}}

    /* table (só do sistema, NÃO vale para a tabela do PDF) */
    .scroll{max-height:520px; overflow:auto; border:1px solid rgba(255,255,255,.08); border-radius:12px; margin-top:10px; background: rgba(0,0,0,.18)}
    .scroll table{border-collapse:collapse; min-width:100%}
    .scroll th,.scroll td{padding:10px 10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;white-space:nowrap}
    .scroll th{
      position:sticky; top:0; z-index:2;
      background: rgba(15,15,18,.95);
      text-align:left;
      font-size:12px;
      letter-spacing:.3px;
      color:#e9e9f4;
      user-select:none;
    }
    .scroll td:first-child, .scroll th:first-child{
      position:sticky; left:0; z-index:3;
      background: rgba(18,18,22,.98);
    }
    .scroll tr:hover td{background: rgba(255,255,255,.03)}

    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:4px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid rgba(255,255,255,.10);
    }
    .b-ok{background: rgba(46,204,113,.14); color:#bff5d3; border-color: rgba(46,204,113,.25)}
    .b-warn{background: rgba(243,156,18,.16); color:#ffe2b2; border-color: rgba(243,156,18,.28)}
    .b-err{background: rgba(231,76,60,.14); color:#ffd0cb; border-color: rgba(231,76,60,.28)}
    .right{margin-left:auto}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .kpi{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi .box{
      flex:1;min-width:220px;
      background: rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      border-radius:12px;
      padding:10px;
    }
    .kpi .box .t{font-size:12px;color:var(--muted)}
    .kpi .box .v{font-size:16px;font-weight:900;margin-top:6px}

    /* loading overlay */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.62);
      display:none;
      align-items:center; justify-content:center;
      z-index:9999;
      backdrop-filter: blur(6px);
    }
    .overlay.on{display:flex}
    .loaderBox{
      width:min(520px, 92vw);
      background: rgba(20,20,24,.92);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:18px;
      box-shadow:var(--shadow);
    }
    .spinner{
      width:42px;height:42px;border-radius:50%;
      border:4px solid rgba(255,255,255,.12);
      border-top-color: rgba(255,255,255,.85);
      animation:spin 1s linear infinite;
      margin-right:12px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loaderRow{display:flex;align-items:center;gap:10px}
    .loaderTitle{font-weight:900}
    .loaderMsg{color:var(--muted);font-size:13px;margin-top:8px}

    /* modal confirm */
    .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:9998}
    .modalWrap.on{display:flex}
    .modalBackdrop{position:absolute;inset:0;background: rgba(0,0,0,.68);backdrop-filter: blur(6px)}
    .modal{
      position:relative;
      width:min(560px, 92vw);
      background: rgba(18,18,22,.96);
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .modal h3{margin:0 0 8px;font-size:16px}
    .modal p{margin:0 0 12px;color:var(--muted);font-size:13px;line-height:1.35}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .hide{display:none !important}

    /* draggable headers hint */
    .dragHint{
      display:inline-flex;align-items:center;gap:8px;
      color:var(--muted);font-size:12px;margin-top:8px
    }
    .thDrag{ cursor:grab; }
    .thDrag:active{cursor:grabbing}
    .thGhost{opacity:.35}
    .thDrop{outline:2px dashed rgba(111,60,207,.65); outline-offset:-4px}

    /* Filter list */
    .filter-list{
      display:flex;
      gap:8px;
      margin-left:10px;
    }
    .filter-list label{
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    /* Novo modal para incluir ref */
    .add-ref-modal .row { margin: 12px 0; }
    .add-ref-modal input { width: 100%; }
    .add-ref-modal .hint { margin-top: 4px; }

    /* Ajuste do campo coleção */
    #collName { min-width: 200px; flex: 1; }

    /* Botões inline */
    .button-group {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* Modal para gravar coleção atual */
    .export-modal .row { margin: 12px 0; }
    .export-modal select, .export-modal input { width: 100%; }

    /* ======= PRINT / PDF ======= */
    #printRoot{
      display:none;
      background:#fff;
      color:#000;
      padding:0;
    }

    /* modal de impressão MAIS CLARO */
    #modalPrintWrap .modal{
      background:#f7f7fb !important;
      color:#111 !important;
      border:1px solid rgba(0,0,0,.15) !important;
    }
    #modalPrintWrap .modal h3{color:#111}
    #modalPrintWrap .modalBackdrop{ background: rgba(0,0,0,.55); }

    /* botão do rodapé do modal (bem visível) */
    #modalPrintWrap .actions .success{
      background: linear-gradient(180deg, #2ecc71, #239a57) !important;
      color:#0a1b10 !important;
      border:1px solid rgba(0,0,0,.12) !important;
    }

    /* tabela do PDF (não herda nada do site) */
    .pdf-wrap{
      background:#fff;
      color:#000;
      padding:18px;
      border-radius:12px;
    }
    .pdf-top{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
      margin-bottom:12px;
      border-bottom:1px solid #ddd;
      padding-bottom:10px;
    }
    .pdf-top .left h1{
      margin:0 0 4px 0;
      font-size:18px;
      font-weight:800;
      color:#000;
      letter-spacing:.2px;
    }
    .pdf-top .left .meta{
      font-size:12px;
      color:#444;
    }
    .pdf-top .right{
      font-size:12px;
      color:#333;
      text-align:right;
      white-space:nowrap;
      margin-left:auto;
    }

    .pdf-table{
      width:100%;
      border-collapse:collapse;
      font-family: Arial, sans-serif;
      font-size:12px;
      background:#fff;
      color:#000;
    }
    .pdf-table th{
      background:#f2f2f2;
      border:1px solid #d6d6d6;
      padding:8px 10px;
      text-align:left;
      font-weight:800;
      color:#111;
    }
    .pdf-table td{
      border:1px solid #d6d6d6;
      padding:8px 10px;
      vertical-align:middle;
      background:#fff; /* garante que não fica escuro */
      color:#000;
    }
    .pdf-table .ref-col{
      font-weight:800;
      font-family:'Courier New', monospace;
      background:#fff !important; /* força a 1ª coluna clara */
      color:#000 !important;
    }
    .pdf-table .price-col{
      text-align:right;
      font-family:'Courier New', monospace;
    }
    .pdf-table .status-col{
      font-weight:900;
      text-transform:uppercase;
    }
    .pdf-table .up{ color:#1f9d4a; font-weight:900; }
    .pdf-table .down{ color:#d63b2f; font-weight:900; }
    .pdf-table .eq{ color:#6b6b6b; font-weight:900; }

    .pdf-foot{
      margin-top:18px;
      font-size:10px;
      color:#666;
      text-align:center;
      padding-top:10px;
      border-top:1px solid #eee;
    }

    /* Impressão real: imprime APENAS o #printRoot */
    @media print {
      /* tenta manter cores */
      *{
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      body{
        background:#fff !important;
      }

      body *{
        visibility:hidden !important;
      }

      #printRoot, #printRoot *{
        visibility:visible !important;
      }

      #printRoot{
        display:block !important;
        position:fixed;
        left:0; top:0;
        width:100%;
        height:auto;
        padding:18px;
      }

      /* remove qualquer coisa do modal */
      .modalWrap, .overlay { display:none !important; }
    }
  </style>
</head>

<body>
  <div class="overlay" id="overlay">
    <div class="loaderBox">
      <div class="loaderRow">
        <div class="spinner"></div>
        <div>
          <div class="loaderTitle" id="overlayTitle">Processando...</div>
          <div class="loaderMsg" id="overlayMsg">Aguarde.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- impressão real (fora do modal) -->
  <div id="printRoot"></div>

  <div class="modalWrap" id="modalWrap">
    <div class="modalBackdrop" onclick="Modal.close(false)"></div>
    <div class="modal">
      <h3 id="modalTitle">Confirmar</h3>
      <p id="modalText">...</p>
      <div class="actions">
        <button class="secondary" id="modalNo">Não</button>
        <button id="modalYes">Sim</button>
      </div>
    </div>
  </div>

  <!-- Modal para incluir ref na coleção atual -->
  <div class="modalWrap" id="modalAddRefWrap">
    <div class="modalBackdrop" onclick="ModalAddRef.close()"></div>
    <div class="modal add-ref-modal">
      <h3>Incluir/Atualizar Referência na Coleção Atual</h3>

      <div class="row">
        <label>Referência e Preço</label>
        <input id="modalRefPrice" placeholder="Ex.: 0227 179,99" style="width:100%"/>
        <div class="hint">Formato: <span class="mono">REF PREÇO</span> (4 dígitos + espaço + valor). Ex: 0227 179,99</div>
      </div>

      <div class="row">
        <label>Coleção atual detectada</label>
        <input id="modalCurrentColl" readonly style="background:rgba(255,255,255,.05); color:var(--muted)"/>
      </div>

      <div class="actions">
        <button class="secondary" onclick="ModalAddRef.close()">Cancelar</button>
        <button id="modalAddRefConfirm">Incluir/Atualizar</button>
      </div>
    </div>
  </div>

  <!-- Modal para gravar coleção atual -->
  <div class="modalWrap" id="modalExportWrap">
    <div class="modalBackdrop" onclick="ModalExport.close()"></div>
    <div class="modal export-modal">
      <h3>Gravar Coleção Atual</h3>

      <div class="row">
        <label>Selecionar coleção</label>
        <select id="modalExportColl" style="width:100%">
          <option value="latest">ÚLTIMA COLEÇÃO (padrão)</option>
        </select>
      </div>

      <div class="row">
        <label>Senha</label>
        <input id="modalExportPass" type="password" placeholder="Digite a senha" style="width:100%"/>
      </div>

      <div class="hint">
        Isso sobrescreve a aba <b>Leonardo</b> nas colunas A:C (REF | VALOR | COLEÇÃO ATUAL).
      </div>

      <div class="actions">
        <button class="secondary" onclick="ModalExport.close()">Cancelar</button>
        <button id="modalExportConfirm">Gravar Coleção Atual</button>
      </div>
    </div>
  </div>

  <!-- Modal de impressão/PDF -->
  <div class="modalWrap" id="modalPrintWrap">
    <div class="modalBackdrop" onclick="ModalPrint.close()"></div>
    <div class="modal" style="width:min(900px, 96vw); max-height:90vh; overflow:auto;">
      <h3>Imprimir Comparação de Coleções</h3>

      <div id="printPreview" style="margin-top:10px;"></div>

      <div class="actions" style="margin-top:14px;">
        <button class="secondary" onclick="ModalPrint.close()">Fechar</button>
        <button onclick="window.print()" class="success">Imprimir / Gerar PDF</button>
      </div>
    </div>
  </div>

  <div class="wrap grid">
    <h1>Precificação — HS</h1>

    <!-- INCLUIR NOVA COLEÇÃO -->
    <div class="panel" id="panelAdd">
      <div class="title">Incluir nova coleção <small>(lista de preço)</small></div>

      <div class="row">
        <div style="min-width:200px;flex:1">
          <label>Nome da coleção</label>
          <input id="collName" placeholder="Ex.: OUTONO 2025 / OUTONO 2025 REM / OUTONO 2025 REM 2" style="width:100%"/>
        </div>

        <div class="button-group">
          <button id="btnSaveColl">Salvar coleção no banco</button>
          <button id="btnAddRefModal" class="secondary">Incluir ref na coleção atual</button>
          <button id="btnExportModal" class="secondary">Gravar coleção atual</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>Cole os itens (1 por linha)</label>
        <div class="hint">
          Aceita: <span class="mono">REF;PREÇO</span> ou <span class="mono">REF PREÇO</span> (recomendado).
          <br/>Ex.: <span class="mono">0227 89,99</span> ou <span class="mono">0227;89,99</span>
        </div>
        <textarea id="collItems" placeholder="Cole aqui..."></textarea>
      </div>
    </div>

    <!-- BUSCAR + INCLUIR REF NA COLEÇÃO ATUAL -->
    <div class="panel" id="panelSearch">
      <div class="title">Buscar referência <small>(histórico por coleção)</small></div>

      <div class="row">
        <div style="min-width:220px">
          <label>Referência</label>
          <input id="refInput" placeholder="Ex.: 0227" style="min-width:220px"/>
        </div>

        <button id="btnBuscar">Buscar</button>
        <span class="hint" id="refStatus"></span>
      </div>

      <div class="kpi" id="refKpis" style="display:none">
        <div class="box">
          <div class="t">Preço atual (última coleção)</div>
          <div class="v" id="kpiAtual">—</div>
        </div>
        <div class="box">
          <div class="t">Coleção atual</div>
          <div class="v" id="kpiAtualColl">—</div>
        </div>
        <div class="box">
          <div class="t">Maior preço (histórico)</div>
          <div class="v" id="kpiMax">—</div>
        </div>
      </div>

      <div id="refTableWrap"></div>
    </div>

    <!-- COMPARAR COLEÇÕES -->
    <div class="panel" id="panelCompare">
      <div class="title">Comparar coleções <small>(subiu / desceu)</small></div>

      <div class="row">
        <div>
          <label>Coleção A (mais antiga)</label>
          <select id="collA" style="min-width:260px"></select>
        </div>

        <div>
          <label>Coleção B (mais atual)</label>
          <select id="collB" style="min-width:260px"></select>
        </div>

        <button id="btnCompare">Comparar</button>
        <button id="btnPrint" class="success" style="display:none">Imprimir / Gerar PDF</button>

        <div class="filter-list">
          <label><input type="radio" name="filterType" value="all" checked/> <span>Todos</span></label>
          <label><input type="radio" name="filterType" value="changed"/> <span>Somente alterou</span></label>
          <label><input type="radio" name="filterType" value="up"/> <span>Somente subiu</span></label>
          <label><input type="radio" name="filterType" value="down"/> <span>Somente desceu</span></label>
        </div>

        <span class="hint right" id="cmpStatus"></span>
      </div>

      <div id="cmpTableWrap"></div>
    </div>

    <!-- MATRIZ -->
    <div class="panel" id="panelMatrix">
      <div class="title">Tabela preços x coleções <small>(reordenar colunas)</small></div>

      <div class="row">
        <div>
          <label>Limitar referências (opcional)</label>
          <input id="matLimit" type="number" min="1" placeholder="Ex.: 400" style="width:150px"/>
        </div>

        <div>
          <label>Buscar ref na matriz</label>
          <input id="matSearch" placeholder="Ex.: 0227" style="min-width:220px"/>
        </div>

        <button id="btnMatrix">Gerar tabela</button>
        <button id="btnResetCols" class="secondary" title="Remove ordem salva e volta pro padrão">Reset colunas</button>

        <span class="hint right" id="matStatus"></span>
      </div>

      <div class="dragHint">
        Dica: depois de gerar, você pode <b>arrastar os nomes das coleções</b> (cabeçalho) para reorganizar. A ordem fica salva no navegador (storage).
      </div>

      <div id="matTableWrap"></div>
    </div>
  </div>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const API_URL = "https://script.google.com/macros/s/AKfycbyFVqDrgXkYThp03XT3xB3Bi0fK3hW-956TIkOmZyb4guFElY4kZYzksy2v2jB3mzWB/exec";
    const fmtBR = (n) => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(n ?? 0);

    /***********************
     * FUNÇÕES AUXILIARES
     ***********************/
    function getLatestCollection() {
      if (collectionsWithKeys.length === 0) return null;
      const sorted = [...collectionsWithKeys].sort((a, b) => b.key - a.key);
      return sorted[0];
    }

    /***********************
     * LOADING
     ***********************/
    const Overlay = {
      on(title="Processando...", msg="Aguarde."){
        document.getElementById("overlayTitle").textContent = title;
        document.getElementById("overlayMsg").textContent = msg;
        document.getElementById("overlay").classList.add("on");
      },
      off(){ document.getElementById("overlay").classList.remove("on"); }
    };

    /***********************
     * MODAL CONFIRM
     ***********************/
    const Modal = {
      _resolver:null,
      ask({title="Confirmar", text="Tem certeza?"}){
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalText").textContent = text;
        document.getElementById("modalWrap").classList.add("on");
        return new Promise((resolve)=>{
          this._resolver = resolve;
          document.getElementById("modalYes").onclick = ()=> this.close(true);
          document.getElementById("modalNo").onclick  = ()=> this.close(false);
        });
      },
      close(ans){
        document.getElementById("modalWrap").classList.remove("on");
        if (this._resolver){ this._resolver(!!ans); this._resolver=null; }
      }
    };

    /***********************
     * MODAL ADD REF
     ***********************/
    const ModalAddRef = {
      _resolver: null,
      open() {
        const lastColl = getLatestCollection();
        document.getElementById("modalCurrentColl").value = lastColl ?
          `${lastColl.name} (Série: ${lastColl.key})` :
          "Nenhuma coleção encontrada";
        document.getElementById("modalRefPrice").value = "";
        document.getElementById("modalAddRefWrap").classList.add("on");
        return new Promise((resolve) => {
          this._resolver = resolve;
          document.getElementById("modalAddRefConfirm").onclick = () => this.close(true);
        });
      },
      close(ans) {
        document.getElementById("modalAddRefWrap").classList.remove("on");
        if (this._resolver) { this._resolver(ans); this._resolver = null; }
      }
    };

    /***********************
     * MODAL EXPORT
     ***********************/
    const ModalExport = {
      _resolver: null,
      open() {
        const select = document.getElementById("modalExportColl");
        select.innerHTML = '<option value="latest">ÚLTIMA COLEÇÃO (padrão)</option>';

        if (collectionsWithKeys.length > 0) {
          const sorted = [...collectionsWithKeys].sort((a, b) => a.key - b.key);
          sorted.forEach(coll => {
            const option = document.createElement("option");
            option.value = coll.name;
            option.textContent = `${coll.name} (Série: ${coll.key})`;
            select.appendChild(option);
          });
          const latest = getLatestCollection();
          if (latest) select.value = latest.name;
        }

        document.getElementById("modalExportPass").value = "";
        document.getElementById("modalExportWrap").classList.add("on");

        return new Promise((resolve) => {
          this._resolver = resolve;
          document.getElementById("modalExportConfirm").onclick = () => this.close(true);
        });
      },
      close(ans) {
        document.getElementById("modalExportWrap").classList.remove("on");
        if (this._resolver) { this._resolver(ans); this._resolver = null; }
      }
    };

    /***********************
     * MODAL PRINT (fix: imprime #printRoot e mostra preview)
     ***********************/
    const ModalPrint = {
      open(data, collA, collB) {
        const printRoot = document.getElementById("printRoot");
        const preview = document.getElementById("printPreview");

        const filteredData = (data || []).filter(item =>
          (item?.direcao === "SUBIU" || item?.direcao === "DESCEU") &&
          item?.precoA != null && item?.precoB != null
        );

        const now = new Date();
        const dateStr =
          now.toLocaleDateString('pt-BR') + ", " +
          now.toLocaleTimeString('pt-BR');

        let html = `
          <div class="pdf-wrap">
            <div class="pdf-top">
              <div class="left">
                <h1>REMARCAÇÃO — ${esc(collA)} → ${esc(collB)}</h1>
                <div class="meta">Gerado em ${dateStr}. Itens: ${filteredData.length}</div>
              </div>
              <div class="right">Precificação — HS</div>
            </div>

            <table class="pdf-table">
              <thead>
                <tr>
                  <th>REF</th>
                  <th>PREÇO ANTERIOR</th>
                  <th>PREÇO ATUAL</th>
                  <th>STATUS</th>
                </tr>
              </thead>
              <tbody>
        `;

        filteredData.forEach(item => {
          const isUp = item.direcao === "SUBIU";
          const statusClass = isUp ? "up" : "down";
          const statusText = isUp ? "SUBIU" : "DESCEU";

          html += `
            <tr>
              <td class="ref-col">${esc(item.referencia)}</td>
              <td class="price-col">${fmtBR(item.precoA)}</td>
              <td class="price-col">${fmtBR(item.precoB)}</td>
              <td class="status-col ${statusClass}">${statusText}</td>
            </tr>
          `;
        });

        html += `
              </tbody>
            </table>

            <div class="pdf-foot">
              Sistema de Precificação HS | Relatório gerado automaticamente
            </div>
          </div>
        `;

        printRoot.innerHTML = html;
        preview.innerHTML = html;

        document.getElementById("modalPrintWrap").classList.add("on");
      },
      close() {
        document.getElementById("modalPrintWrap").classList.remove("on");
      }
    };

    /***********************
     * API helpers
     ***********************/
    async function apiGet(action, params={}){
      const url = new URL(API_URL);
      url.search = new URLSearchParams({ action, ...params }).toString();
      const r = await fetch(url, { method:"GET" });
      return r.json();
    }

    async function apiPost(payload){
      const r = await fetch(API_URL, { method:"POST", body: JSON.stringify(payload) });
      return r.json();
    }

    /***********************
     * UI helpers
     ***********************/
    function renderTable(targetId, header, rows){
      const wrap = document.getElementById(targetId);
      wrap.innerHTML = "";
      const scroll = document.createElement("div");
      scroll.className = "scroll";
      const table = document.createElement("table");
      table.innerHTML =
        `<thead><tr>${header.map(h=>`<th>${h}</th>`).join("")}</tr></thead>
         <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("")}</tbody>`;
      scroll.appendChild(table);
      wrap.appendChild(scroll);
      return table;
    }

    function esc(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;"); }

    function parsePriceBR(str){
      if (str == null) return null;
      const s = String(str).trim().replace(/[R$\s]/g,"");
      if (!s) return null;
      let x = s;
      if (x.includes(",")){
        x = x.replace(/\./g,"").replace(",",".");
      }
      const n = Number(x);
      return Number.isFinite(n) ? Math.round((n + Number.EPSILON)*100)/100 : null;
    }

    /**
     * FIX IMPORTANTE:
     * - NÃO separar por vírgula, porque a vírgula é decimal (59,99)
     * - Aceita:
     *   0227 59,99
     *   0227;59,99
     *   0227\t59,99
     * - Aceita "0227,59.99" SOMENTE se decimal for ponto (caso raro)
     */
    function parseItemsFromTextarea(text){
      const lines = String(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const out = [];

      for (const line of lines){
        let ref = "";
        let priceStr = "";

        // 1) separador ;
        if (line.includes(";")){
          const parts = line.split(";").map(x=>x.trim()).filter(Boolean);
          if (parts.length >= 2){
            ref = parts[0];
            priceStr = parts.slice(1).join(" ").trim();
          }
        }

        // 2) separador por espaço(s) (RECOMENDADO)
        if (!ref){
          const m = line.match(/^(\S+)\s+(.+)$/);
          if (m){
            ref = m[1];
            priceStr = m[2];
          }
        }

        // 3) separador por vírgula SÓ se preço vier com ponto decimal (ex: 89.99)
        if (!ref){
          const m2 = line.match(/^(\S+)\s*,\s*(\d+(?:\.\d{1,2})?)$/);
          if (m2){
            ref = m2[1];
            priceStr = m2[2];
          }
        }

        ref = String(ref||"").trim().toUpperCase();
        const price = parsePriceBR(priceStr);

        if (!ref || price == null) continue;
        out.push({ ref, preco: price });
      }

      return out;
    }

    function parseRefPriceFormat(str) {
      if (!str) return null;
      const s = String(str).trim();
      const match = s.match(/^(\d{4})\s+([\d.,]+)$/);
      if (!match) return null;
      const ref = match[1];
      const price = parsePriceBR(match[2]);
      if (!ref || price == null) return null;
      return { ref, preco: price };
    }

    function setStatus(id, msg){ document.getElementById(id).textContent = msg || ""; }

    /***********************
     * Collections load
     ***********************/
    let collections = [];
    let collectionsWithKeys = [];

    async function loadCollections(){
      try {
        const res = await apiGet("listCollectionsWithKeys");

        if (res?.collections && Array.isArray(res.collections)) {
          collectionsWithKeys = res.collections;
          collections = collectionsWithKeys.map(c => c.name);
        } else {
          const colls = await apiGet("listCollections");
          collections = Array.isArray(colls) ? colls : [];
          collectionsWithKeys = collections.map((name, idx) => ({ name, key: idx, order: idx }));
        }
      } catch (err) {
        console.error("Erro ao carregar coleções:", err);
        const colls = await apiGet("listCollections");
        collections = Array.isArray(colls) ? colls : [];
        collectionsWithKeys = collections.map((name, idx) => ({ name, key: idx, order: idx }));
      }

      const fill = (sel, { withEmpty = true } = {}) => {
        sel.innerHTML = "";
        if (withEmpty) {
          const o = document.createElement("option");
          o.value = "";
          o.textContent = "Selecione";
          sel.appendChild(o);
        }
        const sorted = [...collectionsWithKeys].sort((a, b) => a.key - b.key);
        sorted.forEach(c => {
          const o = document.createElement("option");
          o.value = c.name;
          o.textContent = `${c.name} (${c.key})`;
          sel.appendChild(o);
        });
      };

      fill(document.getElementById("collA"));
      fill(document.getElementById("collB"));
    }

    /***********************
     * SAVE COLLECTION + CONFIRM use as current
     ***********************/
    document.getElementById("btnSaveColl").onclick = async ()=>{
      const name = document.getElementById("collName").value.trim();
      const itemsTxt = document.getElementById("collItems").value;
      const items = parseItemsFromTextarea(itemsTxt);

      if (!name){ alert("Informe o nome da coleção."); return; }
      if (!items.length){ alert("Cole os itens (REF e PREÇO)."); return; }

      const ok = await Modal.ask({
        title:"Salvar coleção",
        text:`Vou salvar a coleção "${name}" com ${items.length} itens no banco. Confirmar?`
      });
      if (!ok) return;

      try{
        Overlay.on("Salvando coleção...", "Gravando no banco de dados.");
        const resp = await apiPost({ action:"addCollection", colecaoNome:name, items });
        if (resp?.erro){ throw new Error(resp.erro); }

        await loadCollections();

        Overlay.off();
        const useAsCurrent = await Modal.ask({
          title:"Usar como lista atual?",
          text:`Deseja gravar a lista atual (aba Leonardo) usando esta coleção recém-salva?\n\nSe SIM, vai pedir a senha.`
        });

        if (useAsCurrent){
          ModalExport.open().then(async (confirmed) => {
            if (!confirmed) return;

            const coll = name;
            const pass = document.getElementById("modalExportPass").value;

            if (!pass){ alert("Digite a senha."); return; }

            try{
              Overlay.on("Gravando COLEÇÃO ATUAL...", "Gerando lista e sobrescrevendo a aba Leonardo.");
              const exp = await apiPost({
                action:"exportCurrentPrices",
                password: pass,
                mode:"upto",
                colecao: coll
              });
              if (exp?.erro){ throw new Error(exp.erro); }
              alert(`OK! Coleção salva e COLEÇÃO ATUAL gravada.\nItens exportados: ${exp.gravados || exp.exported || "?"}`);
            } catch(err){
              alert("Erro: " + err.message);
            } finally {
              Overlay.off();
            }
          });
        } else {
          alert(`OK! Coleção "${resp.colecao || name}" salva (${resp.inseridos || "?"} itens).`);
        }

      } catch(err){
        alert("Erro: " + err.message);
      } finally {
        Overlay.off();
      }
    };

    /***********************
     * BOTÃO PARA ABRIR MODAL DE INCLUIR REF
     ***********************/
    document.getElementById("btnAddRefModal").onclick = async () => {
      const ok = await ModalAddRef.open();
      if (!ok) return;

      const input = document.getElementById("modalRefPrice").value.trim();
      const parsed = parseRefPriceFormat(input);

      if (!parsed) {
        alert("Formato inválido! Use: REF (4 dígitos) + espaço + PREÇO. Ex: 0227 179,99");
        return;
      }

      const { ref, preco } = parsed;

      const pass = prompt("Digite a senha para incluir/atualizar a referência:");
      if (!pass) return;

      try {
        Overlay.on("Processando...", "Incluindo/atualizando referência na coleção atual.");

        const resp = await apiPost({
          action: "addRefToCurrent",
          ref,
          preco,
          password: pass
        });

        if (resp?.erro) throw new Error(resp.erro);

        alert(`OK! Referência ${ref} ${resp.modo === 'atualizado' ? 'atualizada' : 'incluída'} na coleção atual.\nPreço: ${fmtBR(preco)}\nColeção: ${resp.colecaoAtual}`);

        await loadCollections();

        if (document.getElementById("refInput").value.trim().toUpperCase() === ref) {
          document.getElementById("btnBuscar").click();
        }

      } catch(err) {
        alert("Erro: " + err.message);
      } finally {
        Overlay.off();
      }
    };

    /***********************
     * BOTÃO PARA ABRIR MODAL DE EXPORT
     ***********************/
    document.getElementById("btnExportModal").onclick = async () => {
      const ok = await ModalExport.open();
      if (!ok) return;

      const coll = document.getElementById("modalExportColl").value;
      const pass = document.getElementById("modalExportPass").value;

      if (!pass){ alert("Digite a senha."); return; }
      if (coll === "latest" && collections.length === 0){ alert("Nenhuma coleção disponível."); return; }

      const mode = coll === "latest" ? "latest" : "upto";
      const colecao = coll === "latest" ? "" : coll;

      try{
        Overlay.on("Gravando COLEÇÃO ATUAL...", "Gerando lista e sobrescrevendo a aba Leonardo.");
        const resp = await apiPost({
          action:"exportCurrentPrices",
          password: pass,
          mode,
          colecao: colecao
        });
        if (resp?.erro) throw new Error(resp.erro);
        alert(`OK! Itens gravados: ${resp.gravados || resp.exported || "?"}`);
      } catch(err){
        alert("Erro: " + err.message);
      } finally {
        Overlay.off();
      }
    };

    /***********************
     * SEARCH REFERENCE
     ***********************/
    document.getElementById("btnBuscar").onclick = async ()=>{
      const ref = document.getElementById("refInput").value.trim().toUpperCase();
      if (!ref) return;

      setStatus("refStatus", "Buscando...");
      try{
        Overlay.on("Buscando referência...", "Consultando o banco.");
        const res = await apiGet("searchReference", { ref });
        Overlay.off();

        if (!res?.items?.length){
          document.getElementById("refKpis").style.display = "none";
          document.getElementById("refTableWrap").innerHTML = `<div class="hint">Nenhum dado encontrado para <b>${esc(ref)}</b>.</div>`;
          setStatus("refStatus", "");
          return;
        }

        document.getElementById("refKpis").style.display = "flex";
        document.getElementById("kpiAtual").textContent = fmtBR(res.atual?.preco);
        document.getElementById("kpiAtualColl").textContent = res.atual?.colecao || "—";
        document.getElementById("kpiMax").textContent = fmtBR(res.max);

        const rows = res.items.map(i=>{
          const badge = (res.atual?.colecao === i.coll)
            ? `<span class="badge b-ok">ATUAL</span>`
            : ``;
          return [
            esc(i.coll),
            `<span class="mono">${fmtBR(i.price)}</span>`,
            badge
          ];
        });

        renderTable("refTableWrap", ["Coleção", "Preço", ""], rows);
        setStatus("refStatus","");

      } catch(err){
        Overlay.off();
        setStatus("refStatus","");
        alert("Erro: " + err.message);
      }
    };

    /***********************
     * COMPARE
     ***********************/
    let cmpLast = null;

    function applyCompareFilters(data){
      let out = data.slice();
      const filterType = document.querySelector('input[name="filterType"]:checked').value;

      if (filterType === "changed") out = out.filter(r => r.direcao === "SUBIU" || r.direcao === "DESCEU");
      if (filterType === "up")      out = out.filter(r => r.direcao === "SUBIU");
      if (filterType === "down")    out = out.filter(r => r.direcao === "DESCEU");
      return out;
    }

    function renderCompare(data, a, b){
      const filtered = applyCompareFilters(data);

      const rows = filtered.map(r=>{
        const s = r.direcao;
        const badge =
          s === "SUBIU"  ? `<span class="badge b-ok">SUBIU</span>` :
          s === "DESCEU" ? `<span class="badge b-err">DESCEU</span>` :
          s === "IGUAL"  ? `<span class="badge b-warn">IGUAL</span>` :
                           `<span class="badge">SEM DADO</span>`;

        const deltaTxt = (r.delta == null) ? "-" : fmtBR(r.delta);

        return [
          `<span class="mono">${esc(r.referencia)}</span>`,
          r.precoA == null ? "-" : `<span class="mono">${fmtBR(r.precoA)}</span>`,
          r.precoB == null ? "-" : `<span class="mono">${fmtBR(r.precoB)}</span>`,
          `<span class="mono">${deltaTxt}</span>`,
          badge
        ];
      });

      renderTable("cmpTableWrap",
        ["REF", `Preço (${esc(a)})`, `Preço (${esc(b)})`, "Δ", "Status"],
        rows
      );

      const printBtn = document.getElementById("btnPrint");
      printBtn.style.display = filtered.length > 0 ? "inline-flex" : "none";

      setStatus("cmpStatus", `Itens: ${filtered.length}${filtered.length !== data.length ? " (filtrado)" : ""}`);
    }

    async function runCompare(){
      const a = document.getElementById("collA").value;
      const b = document.getElementById("collB").value;
      if (!a || !b){
        document.getElementById("cmpTableWrap").innerHTML = `<div class="hint">Selecione a Coleção A e B.</div>`;
        setStatus("cmpStatus","");
        document.getElementById("btnPrint").style.display = "none";
        return;
      }

      try{
        Overlay.on("Comparando...", "Carregando e comparando as duas coleções.");
        const res = await apiGet("compareCollections", { a, b });
        Overlay.off();

        if (!Array.isArray(res)){ throw new Error("Resposta inválida do servidor."); }
        cmpLast = { data: res, a, b };
        renderCompare(res, a, b);

      } catch(err){
        Overlay.off();
        alert("Erro: " + err.message);
        document.getElementById("btnPrint").style.display = "none";
      }
    }

    document.getElementById("btnCompare").onclick = runCompare;

    document.getElementById("btnPrint").onclick = () => {
      if (!cmpLast) return;
      ModalPrint.open(cmpLast.data, cmpLast.a, cmpLast.b);
    };

    document.querySelectorAll('input[name="filterType"]').forEach(radio=>{
      radio.onchange = ()=>{
        if (!cmpLast) return;
        renderCompare(cmpLast.data, cmpLast.a, cmpLast.b);
      };
    });

    /***********************
     * MATRIZ + draggable columns (storage)
     ***********************/
    const LS_COLORDER = "hs_matrix_col_order_v1";

    function getSavedOrder(){
      try{
        const v = JSON.parse(localStorage.getItem(LS_COLORDER) || "null");
        return Array.isArray(v) ? v : null;
      }catch{ return null; }
    }
    function saveOrder(order){ localStorage.setItem(LS_COLORDER, JSON.stringify(order)); }
    function clearOrder(){ localStorage.removeItem(LS_COLORDER); }

    function reorderMatrixTable(table){
      const saved = getSavedOrder();
      if (!saved) return;

      const ths = Array.from(table.querySelectorAll("thead th"));
      if (ths.length < 2) return;

      const headerNames = ths.slice(1).map(th=>th.dataset.colname);
      const final = saved.filter(c=>headerNames.includes(c)).concat(headerNames.filter(c=>!saved.includes(c)));
      applyColumnOrder(table, final);
    }

    function applyColumnOrder(table, colOrder){
      const headRow = table.tHead.rows[0];
      const bodyRows = Array.from(table.tBodies[0].rows);

      const ths = Array.from(headRow.cells);
      const idxByName = new Map();
      for (let i=1;i<ths.length;i++){
        idxByName.set(ths[i].dataset.colname, i);
      }

      const newIdx = [0];
      colOrder.forEach(name=>{
        const i = idxByName.get(name);
        if (i != null) newIdx.push(i);
      });

      const newThs = newIdx.map(i=>ths[i]);
      newThs.forEach(th=>headRow.appendChild(th));

      bodyRows.forEach(tr=>{
        const tds = Array.from(tr.cells);
        const newTds = newIdx.map(i=>tds[i]);
        newTds.forEach(td=>tr.appendChild(td));
      });
    }

    function enableHeaderDrag(table){
      const headRow = table.tHead.rows[0];
      const ths = Array.from(headRow.cells);

      for (let i=1;i<ths.length;i++){
        const th = ths[i];
        th.classList.add("thDrag");
        th.draggable = true;
      }

      let dragSrc = null;

      function cleanup(){
        Array.from(headRow.cells).forEach(th=>{
          th.classList.remove("thGhost");
          th.classList.remove("thDrop");
        });
      }

      headRow.addEventListener("dragstart", (e)=>{
        const th = e.target.closest("th");
        if (!th || th.cellIndex === 0) return;
        dragSrc = th;
        th.classList.add("thGhost");
        e.dataTransfer.effectAllowed = "move";
      });

      headRow.addEventListener("dragover", (e)=>{
        e.preventDefault();
        const th = e.target.closest("th");
        if (!th || th.cellIndex === 0 || !dragSrc) return;
        cleanup();
        th.classList.add("thDrop");
        e.dataTransfer.dropEffect = "move";
      });

      headRow.addEventListener("drop", (e)=>{
        e.preventDefault();
        const th = e.target.closest("th");
        if (!th || th.cellIndex === 0 || !dragSrc) return;

        const from = dragSrc.cellIndex;
        const to = th.cellIndex;
        if (from === to) return;

        const cur = Array.from(headRow.cells).slice(1).map(x=>x.dataset.colname);
        const moved = cur.splice(from-1, 1)[0];
        cur.splice(to-1, 0, moved);

        applyColumnOrder(table, cur);
        saveOrder(cur);
        cleanup();
        dragSrc = null;
      });

      headRow.addEventListener("dragend", ()=>{
        cleanup();
        dragSrc = null;
      });
    }

    document.getElementById("btnResetCols").onclick = ()=>{
      clearOrder();
      alert("Ordem de colunas resetada. Gere a tabela novamente.");
    };

    document.getElementById("btnMatrix").onclick = async ()=>{
      const limit = document.getElementById("matLimit").value.trim();
      try{
        Overlay.on("Gerando tabela...", "Montando matriz de preços.");
        const res = await apiGet("matrix", { limit });
        Overlay.off();

        if (!res?.header?.length || !res?.rows?.length){
          document.getElementById("matTableWrap").innerHTML = `<div class="hint">Sem dados.</div>`;
          return;
        }

        const header = res.header.map((h, idx)=> idx===0 ? "REF" : esc(h));
        const rows = res.rows.map(r=>{
          return r.map((v, idx)=>{
            if (idx===0) return `<span class="mono">${esc(v)}</span>`;
            return (v==null || v==="") ? "-" : `<span class="mono">${fmtBR(v)}</span>`;
          });
        });

        const table = renderTable("matTableWrap", header, rows);

        const ths = Array.from(table.tHead.rows[0].cells);
        for (let i=1;i<ths.length;i++){
          ths[i].dataset.colname = res.header[i];
        }

        reorderMatrixTable(table);
        enableHeaderDrag(table);

        const input = document.getElementById("matSearch");
        input.oninput = ()=>{
          const term = input.value.trim().toLowerCase();
          const trs = table.tBodies[0].rows;
          for (const tr of trs){
            const ref = tr.cells[0]?.textContent?.toLowerCase() || "";
            tr.style.display = (term && !ref.includes(term)) ? "none" : "";
          }
        };

        setStatus("matStatus", `Refs: ${res.rows.length} | Colunas: ${res.header.length-1}`);

      } catch(err){
        Overlay.off();
        alert("Erro: " + err.message);
      }
    };

    /***********************
     * INIT
     ***********************/
    (async function init(){
      try{
        Overlay.on("Carregando...", "Buscando coleções no banco.");
        await loadCollections();
      } catch(err){
        alert("Não consegui carregar as coleções.\n\n1) Confere se API_URL está correto.\n2) Confere se o Apps Script está publicado e acessível.\n\nErro: " + err.message);
      } finally{
        Overlay.off();
      }

      if (API_URL.includes("COLE_AQUI")){
        alert("ATENÇÃO: você precisa colar a URL do Apps Script em API_URL (no topo do HTML).");
      }
    })();
  </script>
</body>
</html>
