<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Precificação - HS</title>
  <style>
    :root{
      --bg:#000;
      --panel:#1c1c1c;
      --panel2:#151515;
      --muted:#bdbdbd;
      --pri:#673ab7;
      --pri2:#5a31a6;
      --ok:#28a745;
      --warn:#f1c40f;
      --err:#e53935;
      --line:#2c2c2c;
      --chip:#222;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{margin:0 0 18px;font-size:22px}
    .grid{display:grid;gap:16px}
    .panel{background:var(--panel);padding:16px;border-radius:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:#ddd}
    input,select,button{
      padding:10px 12px;border-radius:10px;border:1px solid #333;background:#121212;color:#fff
    }
    input::placeholder{color:#777}
    button{background:var(--pri);border:0;cursor:pointer;font-weight:700}
    button:hover{background:var(--pri2)}
    button.secondary{background:#2f2f2f}
    button.secondary:hover{background:#3a3a3a}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .pill{background:var(--chip);padding:8px 10px;border-radius:10px}
    .section-title{margin:0 0 10px;font-weight:800}
    .right{margin-left:auto}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#101010;border:1px solid #2b2b2b;padding:2px 6px;border-radius:8px;font-size:12px}

    /* TABELA */
    table{border-collapse:collapse;min-width:100%}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:14px;white-space:nowrap}
    th{background:var(--panel2);text-align:left}
    .scroll{max-height:520px; overflow:auto; border:1px solid #333; border-radius:12px; margin-top:12px}
    .scroll table th{
      position:sticky; top:0; z-index:3;
    }
    .scroll table td:first-child,
    .scroll table th:first-child{
      position:sticky; left:0; z-index:4;
      background:var(--panel);
      border-right:1px solid #2b2b2b;
    }

    /* BADGES */
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:800}
    .b-ok{background:rgba(40,167,69,.18);color:#6fe18b}
    .b-warn{background:rgba(241,196,15,.18);color:#ffd86b}
    .b-err{background:rgba(229,57,53,.18);color:#ff9a9a}
    .b-gray{background:rgba(160,160,160,.16);color:#ddd}

    /* chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{background:#141414;border:1px solid #2b2b2b;padding:8px 10px;border-radius:999px;font-size:13px}
    .chip strong{font-weight:900}
    .divider{height:1px;background:#2b2b2b;margin:12px 0}

    /* loading overlay */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; z-index:9999;
      backdrop-filter: blur(2px);
    }
    .overlay .box{
      background:#111;border:1px solid #2b2b2b;border-radius:14px;
      padding:18px 16px; min-width:280px; text-align:center;
      box-shadow:0 10px 40px rgba(0,0,0,.6);
    }
    .spin{
      width:30px;height:30px;border-radius:50%;
      border:3px solid #2b2b2b;border-top-color:#fff;margin:0 auto 10px;
      animation:rot 1s linear infinite;
    }
    @keyframes rot {to{transform:rotate(360deg)}}

    /* filtros rápidos */
    .toggle{
      display:flex;align-items:center;gap:8px;font-size:13px;color:#ddd
    }
    .toggle input{transform:scale(1.1)}
  </style>
</head>
<body>

<div class="overlay" id="overlay">
  <div class="box">
    <div class="spin"></div>
    <div id="overlayText" style="font-weight:800">Carregando…</div>
    <div class="muted" style="margin-top:6px">Aguarde só um instante.</div>
  </div>
</div>

<div class="wrap grid">
  <h1>Precificação — HS</h1>

  <!-- 1) BUSCA POR REFERÊNCIA -->
  <div class="panel">
    <div class="section-title">Buscar referência</div>

    <div class="row">
      <label>Referência</label>
      <input id="refInput" placeholder="Ex.: 0227" style="min-width:200px" />
      <button id="btnBuscarRef">Buscar</button>

      <button id="btnIncluir" class="secondary">Incluir na lista</button>
      <button id="btnFinalizar" class="secondary">Finalizar lista</button>

      <span id="refStatus" class="muted right"></span>
    </div>

    <div class="chips" id="refResumo" style="display:none">
      <div class="chip">Maior preço (histórico): <strong id="refMax">-</strong></div>
      <div class="chip">Coleção(ões) do maior preço: <strong id="refMaxCols">-</strong></div>
      <div class="chip">Preço atual (última coleção): <strong id="refAtualPreco">-</strong></div>
      <div class="chip">Coleção atual: <strong id="refAtualCol">-</strong></div>
    </div>

    <div id="refTabelaWrap"></div>
  </div>

  <!-- 2) COMPARAR COLEÇÕES -->
  <div class="panel">
    <div class="section-title">Comparar coleções</div>

    <div class="row">
      <label>Coleção A</label>
      <select id="collA" style="min-width:260px"></select>

      <label>Coleção B</label>
      <select id="collB" style="min-width:260px"></select>

      <button id="btnComparar">Comparar</button>

      <label class="toggle">
        <input type="checkbox" id="cmpOnlyChanged">
        Somente alterações
      </label>

      <label class="toggle">
        <input type="checkbox" id="cmpOnlyUp">
        Somente subiu
      </label>

      <label class="toggle">
        <input type="checkbox" id="cmpOnlyDown">
        Somente desceu
      </label>

      <span id="cmpStatus" class="muted right"></span>
    </div>

    <div id="cmpTabelaWrap"></div>
  </div>

  <!-- 3) ADICIONAR NOVA COLEÇÃO (UPLOAD) -->
  <div class="panel">
    <div class="section-title">Incluir nova coleção (gravar no banco)</div>

    <div class="row">
      <label>Nome da coleção</label>
      <input id="newCollName" placeholder="Ex.: INVERNO 2025 REM 2" style="min-width:260px"/>

      <button id="btnAddColl">Salvar coleção</button>
      <span id="addStatus" class="muted right"></span>
    </div>

    <div class="muted" style="margin-top:8px">
      Cole uma lista no formato <span class="kbd">REF;PREÇO</span> (uma por linha). Ex:<br/>
      <span class="kbd">0227;89,99</span>
    </div>

    <textarea id="newCollItems" style="width:100%;margin-top:10px;min-height:160px;border-radius:12px;border:1px solid #333;background:#101010;color:#fff;padding:12px" placeholder="Cole aqui…"></textarea>
  </div>

  <!-- 4) GRAVAR COLEÇÃO ATUAL (EXPORT LEONARDO) -->
  <div class="panel">
    <div class="section-title">Gravar coleção atual (exportar para planilha Leonardo)</div>

    <div class="row">
      <label>Gerar a partir de</label>
      <select id="exportBase" style="min-width:260px"></select>

      <label>Senha</label>
      <input id="exportPass" type="password" placeholder="Senha" style="min-width:180px"/>

      <button id="btnExport">Gravar coleção atual</button>

      <span id="exportStatus" class="muted right"></span>
    </div>

    <div class="muted" style="margin-top:8px">
      Isso sobrescreve a aba <strong>Leonardo</strong> (A:C) com: REF | VALOR | <strong>COLEÇÃO ATUAL</strong>.
    </div>
  </div>

  <!-- 5) MAIOR PREÇO POR REFERÊNCIA -->
  <div class="panel">
    <div class="section-title">Maior preço por referência</div>

    <div class="row">
      <label>Filtrar coleção</label>
      <select id="maxColl" style="min-width:260px"></select>
      <button id="btnMax">Gerar/Atualizar</button>
      <span id="maxStatus" class="muted right"></span>
    </div>

    <div id="maxTabelaWrap"></div>
  </div>

  <!-- 6) MATRIZ PREÇOS x COLEÇÕES -->
  <div class="panel">
    <div class="section-title">Tabela preços x coleções</div>

    <div class="row">
      <label>Limitar primeiras N referências</label>
      <input id="matLimit" type="number" min="1" style="width:160px" placeholder="ex.: 200"/>

      <label>Buscar referência</label>
      <input id="matSearch" placeholder="Ex.: 0227" style="width:220px"/>

      <button id="btnMatriz">Gerar tabela</button>

      <span id="matStatus" class="muted right"></span>
    </div>

    <div class="muted" style="margin-top:8px">
      Dica: a busca filtra em tempo real pela coluna REF.
    </div>

    <div id="matTabelaWrap"></div>
  </div>

</div>

<script>
  // ======================
  // CONFIG
  // ======================
  const API_URL = "https://script.google.com/macros/s/SEU_DEPLOY_AQUI/exec";

  // formatação correta (resolve “casas decimais demais”)
  const fmtBR = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(n||0));

  // lista temporária (include/finalizar lista)
  let listaTemp = [];

  // ======================
  // HELPERS UI
  // ======================
  function showOverlay(msg="Carregando…"){
    document.getElementById("overlayText").textContent = msg;
    document.getElementById("overlay").style.display = "flex";
  }
  function hideOverlay(){
    document.getElementById("overlay").style.display = "none";
  }

  async function apiGet(action, params={}){
    const url = new URL(API_URL);
    url.search = new URLSearchParams({action, ...params}).toString();
    const res = await fetch(url);
    return res.json();
  }
  async function apiPost(payload){
    const res = await fetch(API_URL, {method:"POST", body: JSON.stringify(payload)});
    return res.json();
  }

  function renderTable(containerId, head, rows){
    const wrap = document.getElementById(containerId);
    wrap.innerHTML = '';

    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
      <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
    `;

    const scroll = document.createElement('div');
    scroll.className = 'scroll';
    scroll.appendChild(table);

    wrap.appendChild(scroll);
  }

  function badgeDirecao(dir){
    if (dir === "SUBIU") return `<span class="badge b-ok">SUBIU</span>`;
    if (dir === "DESCEU") return `<span class="badge b-err">DESCEU</span>`;
    if (dir === "IGUAL") return `<span class="badge b-warn">IGUAL</span>`;
    return `<span class="badge b-gray">${dir || "SEM DADO"}</span>`;
  }

  // ======================
  // LOAD COLLECTIONS
  // ======================
  async function loadCollections(){
    showOverlay("Carregando coleções…");
    try{
      const colls = await apiGet("listCollections");
      const fill = (sel, addAll=false) => {
        sel.innerHTML = (addAll ? `<option value="">Todas</option>` : `<option value="">Selecione</option>`);
        colls.forEach(c=>{
          const o = document.createElement('option');
          o.value = o.textContent = c;
          sel.appendChild(o);
        });
      };
      fill(document.getElementById('collA'));
      fill(document.getElementById('collB'));
      fill(document.getElementById('maxColl'), true);
      fill(document.getElementById('exportBase'), true);
    } finally {
      hideOverlay();
    }
  }
  loadCollections();

  // ======================
  // BUSCAR REFERÊNCIA
  // ======================
  document.getElementById('btnBuscarRef').onclick = async ()=>{
    const ref = document.getElementById('refInput').value.trim().toUpperCase();
    const status = document.getElementById('refStatus');
    status.textContent = 'Buscando…';
    showOverlay("Buscando referência…");
    try{
      const res = await apiGet("searchReference", {ref});

      if(!res.items || !res.items.length){
        document.getElementById('refResumo').style.display='none';
        document.getElementById('refTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Nenhum dado encontrado.</div>';
        status.textContent='';
        return;
      }

      document.getElementById('refMax').textContent = fmtBR(res.max);
      document.getElementById('refMaxCols').textContent = (res.maxCollections||[]).join(', ') || '-';

      document.getElementById('refAtualPreco').textContent = res.atual ? fmtBR(res.atual.preco) : '-';
      document.getElementById('refAtualCol').textContent   = res.atual ? res.atual.colecao : '-';

      document.getElementById('refResumo').style.display='flex';

      const rows = res.items.map(i=>[i.coll, fmtBR(i.price)]);
      renderTable('refTabelaWrap', ["Coleção","Preço"], rows);

      status.textContent = '';
    } finally {
      hideOverlay();
    }
  };

  // ======================
  // INCLUIR / FINALIZAR LISTA (para mandar CSV por e-mail se você usa)
  // ======================
  document.getElementById('btnIncluir').onclick = async ()=>{
    const ref = document.getElementById('refInput').value.trim().toUpperCase();
    if(!ref) return;

    showOverlay("Incluindo na lista…");
    try{
      const res = await apiGet("searchReference", {ref});
      if(res.items && res.items.length){
        res.items.forEach(i => listaTemp.push({ref, coll: i.coll, price: i.price}));
        alert("Adicionado: " + ref);
      } else {
        alert("Sem dados para: " + ref);
      }
    } finally {
      hideOverlay();
    }
  };

  document.getElementById('btnFinalizar').onclick = async ()=>{
    if(!listaTemp.length){ alert("Lista vazia."); return; }
    showOverlay("Finalizando lista…");
    try{
      const resp = await apiPost({action:"sendList", items: listaTemp});
      if(resp.status === "ok"){
        alert("Enviado " + resp.enviados + " itens.");
        listaTemp = [];
      } else {
        alert(resp.erro || "Falha ao enviar.");
      }
    } finally {
      hideOverlay();
    }
  };

  // ======================
  // COMPARAR COLEÇÕES
  // ======================
  async function runCompare(){
    const a = document.getElementById('collA').value;
    const b = document.getElementById('collB').value;
    const onlyChanged = document.getElementById('cmpOnlyChanged').checked;
    const onlyUp = document.getElementById('cmpOnlyUp').checked;
    const onlyDown = document.getElementById('cmpOnlyDown').checked;

    if(!a || !b) return;

    document.getElementById('cmpStatus').textContent = 'Comparando…';
    showOverlay("Comparando coleções…");
    try{
      let rows = await apiGet("compareCollections",{a,b});
      rows = rows || [];

      // filtros
      if(onlyChanged) rows = rows.filter(r => r.alterou);
      if(onlyUp) rows = rows.filter(r => r.direcao === "SUBIU");
      if(onlyDown) rows = rows.filter(r => r.direcao === "DESCEU");

      const body = rows.map(r => ([
        r.referencia,
        r.precoA==null ? '-' : fmtBR(r.precoA),
        r.precoB==null ? '-' : fmtBR(r.precoB),
        r.delta==null ? '-' : fmtBR(r.delta),
        badgeDirecao(r.direcao)
      ]));

      renderTable('cmpTabelaWrap', ["REF", `Preço (${a})`, `Preço (${b})`, "Δ", "Status"], body);

      document.getElementById('cmpStatus').textContent = rows.length + " itens";
    } finally {
      hideOverlay();
    }
  }

  document.getElementById('btnComparar').onclick = runCompare;
  document.getElementById('cmpOnlyChanged').onchange = runCompare;
  document.getElementById('cmpOnlyUp').onchange = runCompare;
  document.getElementById('cmpOnlyDown').onchange = runCompare;

  // ======================
  // ADICIONAR COLEÇÃO (POST addCollection)
  // ======================
  document.getElementById('btnAddColl').onclick = async ()=>{
    const name = document.getElementById('newCollName').value.trim();
    const txt  = document.getElementById('newCollItems').value.trim();
    const st   = document.getElementById('addStatus');

    if(!name){ alert("Informe o nome da coleção."); return; }
    if(!txt){ alert("Cole os itens no campo abaixo."); return; }

    // parse "REF;PRECO"
    const lines = txt.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    const items = [];
    for(const line of lines){
      const parts = line.split(";").map(x=>x.trim());
      if(parts.length < 2) continue;
      const ref = parts[0].toUpperCase();
      const price = parts[1];
      items.push({ref, price});
    }
    if(!items.length){ alert("Nenhuma linha válida no formato REF;PREÇO."); return; }

    st.textContent = "Salvando…";
    showOverlay("Salvando coleção…");
    try{
      const resp = await apiPost({action:"addCollection", name, items});
      if(resp.status === "ok"){
        st.textContent = `OK — ${resp.inserted} itens gravados em "${resp.colecao}"`;
        // recarrega coleções para aparecer no site
        await loadCollections();
        alert("Coleção salva com sucesso!");
      } else {
        st.textContent = resp.erro || "Erro ao salvar.";
        alert(resp.erro || "Erro ao salvar.");
      }
    } finally {
      hideOverlay();
    }
  };

  // ======================
  // EXPORTAR “COLEÇÃO ATUAL” (POST exportCurrentPrices)
  // ======================
  document.getElementById('btnExport').onclick = async ()=>{
    const baseCollection = document.getElementById('exportBase').value; // vazio = última
    const password = document.getElementById('exportPass').value;
    const st = document.getElementById('exportStatus');

    if(!password){ alert("Digite a senha."); return; }

    st.textContent = "Exportando…";
    showOverlay("Exportando coleção atual…");
    try{
      const resp = await apiPost({action:"exportCurrentPrices", password, baseCollection});
      if(resp.status === "ok"){
        st.textContent = `OK — ${resp.exported} itens (base: ${resp.cutoff})`;
        alert("Exportação concluída!");
      } else {
        st.textContent = resp.erro || "Senha inválida / erro.";
        alert(resp.erro || "Erro.");
      }
    } finally {
      hideOverlay();
    }
  };

  // ======================
  // MAX POR REFERÊNCIA (GET maxByReference)
  // ======================
  document.getElementById('btnMax').onclick = async ()=>{
    const coll = document.getElementById('maxColl').value;
    const st = document.getElementById('maxStatus');
    st.textContent = "Gerando…";
    showOverlay("Calculando maiores preços…");
    try{
      const list = await apiGet("maxByReference",{colecao: coll});
      if(!list || !list.length){
        document.getElementById('maxTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Sem dados.</div>';
        st.textContent = "";
        return;
      }
      const rows = list.map(r=>[r.referencia, fmtBR(r.max)]);
      renderTable('maxTabelaWrap', ["Referência","MAX de valor"], rows);
      st.textContent = list.length + " refs";
    } finally {
      hideOverlay();
    }
  };

  // ======================
  // MATRIZ (GET matrix) + filtro em tempo real
  // ======================
  document.getElementById('btnMatriz').onclick = async ()=>{
    const limit = document.getElementById('matLimit').value;
    const st = document.getElementById('matStatus');
    st.textContent = "Gerando…";
    showOverlay("Montando tabela (matriz)…");
    try{
      const obj = await apiGet("matrix",{limit});
      if(!obj || !obj.rows || !obj.rows.length){
        document.getElementById('matTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Sem dados.</div>';
        st.textContent = "";
        return;
      }

      // formata
      const rows = obj.rows.map(r=>r.map((v,i)=> i===0 ? v : (v==null ? '-' : fmtBR(v))));

      // render
      renderTable('matTabelaWrap', obj.header, rows);
      st.textContent = `${obj.rows.length} linhas`;

      // filtro tempo real (sem clicar em gerar)
      document.getElementById('matSearch').oninput = ()=>{
        const term = document.getElementById('matSearch').value.trim().toLowerCase();
        const tbody = document.querySelector('#matTabelaWrap tbody');
        if(!tbody) return;
        [...tbody.querySelectorAll('tr')].forEach(tr=>{
          const ref = (tr.querySelector('td')?.textContent || "").toLowerCase();
          tr.style.display = (!term || ref.includes(term)) ? "" : "none";
        });
      };

    } finally {
      hideOverlay();
    }
  };
</script>

</body>
</html>
