<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Precificação - HS</title>

  <style>
    :root{
      --bg:#000;
      --panel:#1c1c1c;
      --panel2:#151515;
      --muted:#bdbdbd;
      --pri:#673ab7;
      --pri2:#5a31a6;
      --ok:#28a745;
      --warn:#f1c40f;
      --err:#e53935;
      --line:#2c2c2c;
      --chip:#222;
      --shadow: 0 10px 40px rgba(0,0,0,.65);
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:var(--bg);color:#fff}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    h1{margin:0 0 18px;font-size:22px}
    .grid{display:grid;gap:16px}
    .panel{background:var(--panel);padding:16px;border-radius:12px; box-shadow: 0 6px 20px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-size:13px;color:#ddd}
    input,select,button,textarea{
      padding:10px 12px;border-radius:10px;border:1px solid #333;background:#121212;color:#fff
    }
    input::placeholder, textarea::placeholder{color:#777}
    button{background:var(--pri);border:0;cursor:pointer;font-weight:800}
    button:hover{background:var(--pri2)}
    button.secondary{background:#2f2f2f}
    button.secondary:hover{background:#3a3a3a}
    button.danger{background:#8e1f1f}
    button.danger:hover{background:#a52626}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:12px}
    .pill{background:var(--chip);padding:8px 10px;border-radius:10px}
    .section-title{margin:0 0 10px;font-weight:900}
    .right{margin-left:auto}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, monospace;background:#101010;border:1px solid #2b2b2b;padding:2px 6px;border-radius:8px;font-size:12px}

    /* TABELA */
    table{border-collapse:collapse;min-width:100%}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:14px;white-space:nowrap}
    th{background:var(--panel2);text-align:left}
    .scroll{max-height:520px; overflow:auto; border:1px solid #333; border-radius:12px; margin-top:12px}
    .scroll table th{position:sticky; top:0; z-index:3;}
    .scroll table td:first-child,
    .scroll table th:first-child{
      position:sticky; left:0; z-index:4;
      background:var(--panel);
      border-right:1px solid #2b2b2b;
    }

    /* BADGES */
    .badge{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:900}
    .b-ok{background:rgba(40,167,69,.18);color:#6fe18b}
    .b-warn{background:rgba(241,196,15,.18);color:#ffd86b}
    .b-err{background:rgba(229,57,53,.18);color:#ff9a9a}
    .b-gray{background:rgba(160,160,160,.16);color:#ddd}

    /* chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{background:#141414;border:1px solid #2b2b2b;padding:8px 10px;border-radius:999px;font-size:13px}
    .chip strong{font-weight:900}
    .divider{height:1px;background:#2b2b2b;margin:12px 0}

    /* overlay loading (forte + trava tudo) */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.82);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
      backdrop-filter: blur(3px);
    }
    .overlay .box{
      background:#0e0e0e;border:1px solid #2b2b2b;border-radius:16px;
      padding:18px 18px; min-width:320px; text-align:center;
      box-shadow: var(--shadow);
    }
    .spin{
      width:34px;height:34px;border-radius:50%;
      border:4px solid #2b2b2b;border-top-color:#fff;margin:0 auto 12px;
      animation:rot 1s linear infinite;
    }
    @keyframes rot {to{transform:rotate(360deg)}}

    /* bloqueio geral quando busy */
    body.busy * { pointer-events:none; user-select:none; }
    body.busy .overlay, body.busy .overlay * { pointer-events:auto; }

    /* toggle */
    .toggle{display:flex;align-items:center;gap:8px;font-size:13px;color:#ddd}
    .toggle input{transform:scale(1.1)}

    /* Drawer / painel escondido (Alterar lista de preço) */
    .drawer{
      display:none;
      margin-top:12px;
      border:1px solid #333;
      border-radius:14px;
      background:#121212;
      padding:12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .drawer.open{display:block}

    /* Modal confirmação */
    .modal-backdrop{
      position:fixed; inset:0; display:none;
      background:rgba(0,0,0,.75);
      z-index:9998;
      align-items:center; justify-content:center;
      backdrop-filter: blur(2px);
    }
    .modal{
      width:min(520px, 92vw);
      background:#101010;
      border:1px solid #2b2b2b;
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h3{margin:0 0 8px;font-size:16px}
    .modal p{margin:0 0 12px;color:#ddd;font-size:13px;line-height:1.4}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .modal .inline{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid #2b2b2b;
    }
    .hint{color:#bdbdbd;font-size:12px}
  </style>
</head>

<body>
  <!-- LOADING -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="box">
      <div class="spin"></div>
      <div id="overlayText" style="font-weight:900;font-size:15px">Processando…</div>
      <div class="muted" style="margin-top:6px">Aguarde finalizar para continuar.</div>
    </div>
  </div>

  <!-- MODAL CONFIRMAÇÃO (salvar e opcionalmente exportar) -->
  <div class="modal-backdrop" id="confirmBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <h3 id="confirmTitle">Confirmar</h3>
      <p id="confirmText"></p>

      <div class="inline" id="confirmExportInline" style="display:none">
        <label style="min-width:60px">Senha</label>
        <input id="confirmPassword" type="password" placeholder="Digite a senha" style="min-width:220px">
        <span class="hint">Se confirmar, vai exportar como <strong>COLEÇÃO ATUAL</strong>.</span>
      </div>

      <div class="actions">
        <button class="secondary" id="btnConfirmNo">Não</button>
        <button class="secondary" id="btnConfirmYes">Sim</button>
        <button id="btnConfirmGo" style="display:none">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="wrap grid">
    <h1>Precificação — HS</h1>

    <!-- INCLUIR NOVA COLEÇÃO -->
    <div class="panel">
      <div class="section-title">Incluir nova coleção (lista de preço)</div>

      <div class="row">
        <label>Nome da coleção</label>
        <input id="newCollName" placeholder="Ex.: OUTONO 25 REM 2" style="min-width:260px"/>

        <button id="btnAddColl">Salvar coleção no banco</button>

        <!-- BOTÃO QUE ESCONDE/MOSTRA A ÁREA “COLEÇÃO ATUAL” -->
        <button id="btnToggleDrawer" class="secondary">Alterar lista de preço</button>

        <span id="addStatus" class="muted right"></span>
      </div>

      <div class="muted" style="margin-top:10px">
        Cole os itens (1 por linha). Aceita: <span class="kbd">REF;PREÇO</span> ou <span class="kbd">REF,PREÇO</span>.
        Ex: <span class="kbd">0227;89,99</span>
      </div>

      <textarea id="newCollItems" style="width:100%;margin-top:10px;min-height:160px;border-radius:12px;background:#101010;color:#fff;padding:12px" placeholder="Cole aqui…"></textarea>

      <!-- DRAWER (ESCONDIDO) -->
      <div class="drawer" id="priceDrawer">
        <div class="section-title" style="margin:0 0 10px">Gravar Coleção Atual (aba Leonardo)</div>

        <div class="row">
          <label>Gerar lista “até”</label>
          <select id="exportBase" style="min-width:260px">
            <!-- preenchido via loadCollections -->
          </select>

          <label>Senha</label>
          <input id="exportPass" type="password" placeholder="Senha" style="min-width:200px"/>

          <button id="btnExport">Gravar COLEÇÃO ATUAL</button>

          <span id="exportStatus" class="muted right"></span>
        </div>

        <div class="muted" style="margin-top:8px">
          Isso sobrescreve a aba <strong>Leonardo</strong> nas colunas A:C (REF | VALOR | <strong>COLEÇÃO ATUAL</strong>).
        </div>
      </div>
    </div>

    <!-- BUSCAR REFERÊNCIA -->
    <div class="panel">
      <div class="section-title">Buscar referência</div>

      <div class="row">
        <label>Referência</label>
        <input id="refInput" placeholder="Ex.: 0227" style="min-width:200px" />
        <button id="btnBuscarRef">Buscar</button>

        <span id="refStatus" class="muted right"></span>
      </div>

      <div class="chips" id="refResumo" style="display:none">
        <div class="chip">Maior preço (histórico): <strong id="refMax">-</strong></div>
        <div class="chip">Coleção(ões) do maior preço: <strong id="refMaxCols">-</strong></div>
        <div class="chip">Preço atual (última coleção): <strong id="refAtualPreco">-</strong></div>
        <div class="chip">Coleção atual: <strong id="refAtualCol">-</strong></div>
      </div>

      <div id="refTabelaWrap"></div>
    </div>

    <!-- COMPARAR COLEÇÕES -->
    <div class="panel">
      <div class="section-title">Comparar coleções</div>

      <div class="row">
        <label>Coleção A</label>
        <select id="collA" style="min-width:260px"></select>

        <label>Coleção B</label>
        <select id="collB" style="min-width:260px"></select>

        <button id="btnComparar">Comparar</button>

        <label class="toggle"><input type="checkbox" id="cmpOnlyChanged"> Somente alterou</label>
        <label class="toggle"><input type="checkbox" id="cmpOnlyUp"> Somente subiu</label>
        <label class="toggle"><input type="checkbox" id="cmpOnlyDown"> Somente desceu</label>

        <span id="cmpStatus" class="muted right"></span>
      </div>

      <div id="cmpTabelaWrap"></div>
    </div>

    <!-- MAX POR REFERÊNCIA -->
    <div class="panel">
      <div class="section-title">Maior preço por referência</div>

      <div class="row">
        <label>Filtrar coleção</label>
        <select id="maxColl" style="min-width:260px"></select>
        <button id="btnMax">Gerar/Atualizar</button>
        <span id="maxStatus" class="muted right"></span>
      </div>

      <div id="maxTabelaWrap"></div>
    </div>

    <!-- MATRIZ PREÇOS x COLEÇÕES -->
    <div class="panel">
      <div class="section-title">Tabela preços x coleções</div>

      <div class="row">
        <label>Limitar primeiras N referências</label>
        <input id="matLimit" type="number" min="1" style="width:160px" placeholder="ex.: 200"/>

        <label>Buscar referência</label>
        <input id="matSearch" placeholder="Ex.: 0227" style="width:220px"/>

        <button id="btnMatriz">Gerar tabela</button>

        <span id="matStatus" class="muted right"></span>
      </div>

      <div class="muted" style="margin-top:8px">
        A busca filtra em tempo real pela coluna REF.
      </div>

      <div id="matTabelaWrap"></div>
    </div>

  </div>

<script>
  // ======================
  // CONFIG
  // ======================
  const API_URL = "https://script.google.com/macros/s/SEU_DEPLOY_AQUI/exec";

  // formatação correta (R$ 89,99)
  const fmtBR = n => new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(Number(n || 0));

  // ======================
  // BUSY / LOADING FORTE
  // ======================
  function setBusy(on, msg="Processando…"){
    const overlay = document.getElementById("overlay");
    document.getElementById("overlayText").textContent = msg;
    if(on){
      document.body.classList.add("busy");
      overlay.style.display = "flex";
      overlay.setAttribute("aria-hidden","false");
    } else {
      document.body.classList.remove("busy");
      overlay.style.display = "none";
      overlay.setAttribute("aria-hidden","true");
    }
  }

  // ======================
  // API
  // ======================
  async function apiGet(action, params={}){
    const url = new URL(API_URL);
    url.search = new URLSearchParams({action, ...params}).toString();
    const res = await fetch(url);
    return res.json();
  }
  async function apiPost(payload){
    const res = await fetch(API_URL, {method:"POST", body: JSON.stringify(payload)});
    return res.json();
  }

  // ======================
  // TABLE RENDER
  // ======================
  function renderTable(containerId, head, rows){
    const wrap = document.getElementById(containerId);
    wrap.innerHTML = '';
    const table = document.createElement('table');
    table.innerHTML = `
      <thead><tr>${head.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
      <tbody>${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
    `;
    const scroll = document.createElement('div');
    scroll.className = 'scroll';
    scroll.appendChild(table);
    wrap.appendChild(scroll);
  }

  function badgeDirecao(dir){
    if (dir === "SUBIU") return `<span class="badge b-ok">SUBIU</span>`;
    if (dir === "DESCEU") return `<span class="badge b-err">DESCEU</span>`;
    if (dir === "IGUAL") return `<span class="badge b-warn">IGUAL</span>`;
    return `<span class="badge b-gray">${dir || "SEM DADO"}</span>`;
  }

  // ======================
  // DRAWER toggle
  // ======================
  const drawer = document.getElementById("priceDrawer");
  document.getElementById("btnToggleDrawer").onclick = ()=>{
    drawer.classList.toggle("open");
  };

  // ======================
  // LOAD COLLECTIONS
  // ======================
  async function loadCollections(){
    setBusy(true, "Carregando coleções…");
    try{
      const colls = await apiGet("listCollections");

      const fill = (sel, addAll=false) => {
        sel.innerHTML = (addAll ? `<option value="">ÚLTIMA (padrão)</option>` : `<option value="">Selecione</option>`);
        colls.forEach(c=>{
          const o = document.createElement('option');
          o.value = o.textContent = c;
          sel.appendChild(o);
        });
      };

      fill(document.getElementById('collA'));
      fill(document.getElementById('collB'));
      fill(document.getElementById('maxColl'), true);
      fill(document.getElementById('exportBase'), true);

    } finally {
      setBusy(false);
    }
  }
  loadCollections();

  // ======================
  // MODAL CONFIRMAÇÃO (Salvar -> usar como atual? -> senha)
  // ======================
  const confirmBackdrop = document.getElementById("confirmBackdrop");
  const confirmText = document.getElementById("confirmText");
  const confirmExportInline = document.getElementById("confirmExportInline");
  const confirmPassword = document.getElementById("confirmPassword");
  const btnConfirmNo = document.getElementById("btnConfirmNo");
  const btnConfirmYes = document.getElementById("btnConfirmYes");
  const btnConfirmGo = document.getElementById("btnConfirmGo");

  let _confirmResolve = null;
  let _confirmState = { step: 1, wantExport: false };

  function openConfirmSaveModal({name, count}){
    confirmPassword.value = "";
    confirmExportInline.style.display = "none";
    btnConfirmGo.style.display = "none";
    btnConfirmNo.style.display = "inline-block";
    btnConfirmYes.style.display = "inline-block";

    _confirmState = { step: 1, wantExport: false };

    document.getElementById("confirmTitle").textContent = "Confirmar envio da coleção";
    confirmText.innerHTML = `
      Você vai salvar a coleção <strong>${escapeHtml(name)}</strong> com <strong>${count}</strong> itens.<br><br>
      Quer usar essa coleção como <strong>LISTA DE PREÇO ATUAL</strong> agora?
    `;

    confirmBackdrop.style.display = "flex";
    confirmBackdrop.setAttribute("aria-hidden","false");

    return new Promise(resolve => { _confirmResolve = resolve; });
  }

  function closeConfirmModal(){
    confirmBackdrop.style.display = "none";
    confirmBackdrop.setAttribute("aria-hidden","true");
    const r = _confirmResolve;
    _confirmResolve = null;
    return r;
  }

  btnConfirmNo.onclick = ()=>{
    const r = closeConfirmModal();
    if(r) r({useAsCurrent:false, password:""});
  };

  btnConfirmYes.onclick = ()=>{
    // revela senha + botão confirmar
    confirmExportInline.style.display = "flex";
    btnConfirmGo.style.display = "inline-block";
    btnConfirmNo.style.display = "inline-block";
    btnConfirmYes.style.display = "none";
    confirmPassword.focus();
  };

  btnConfirmGo.onclick = ()=>{
    const pass = String(confirmPassword.value || "");
    const r = closeConfirmModal();
    if(r) r({useAsCurrent:true, password: pass});
  };

  // fechar modal clicando fora (opcional)
  confirmBackdrop.addEventListener("click", (e)=>{
    if(e.target === confirmBackdrop){
      const r = closeConfirmModal();
      if(r) r({useAsCurrent:false, password:""});
    }
  });

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // ======================
  // ADICIONAR COLEÇÃO
  // ======================
  function parseItemsText(txt){
    const lines = txt.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    const items = [];

    for(const line of lines){
      // aceita ; ou ,
      let parts = line.includes(";") ? line.split(";") : line.split(",");
      parts = parts.map(x=>x.trim());
      if(parts.length < 2) continue;

      const ref = parts[0].toUpperCase();
      const price = parts[1];
      if(!ref) continue;
      items.push({ref, price});
    }
    return items;
  }

  document.getElementById('btnAddColl').onclick = async ()=>{
    const name = document.getElementById('newCollName').value.trim();
    const txt  = document.getElementById('newCollItems').value.trim();
    const st   = document.getElementById('addStatus');

    if(!name){ alert("Informe o nome da coleção."); return; }
    if(!txt){ alert("Cole os itens no campo abaixo."); return; }

    const items = parseItemsText(txt);
    if(!items.length){ alert("Nenhuma linha válida. Use REF;PREÇO (1 por linha)."); return; }

    // Confirmação + senha se quiser usar como atual
    const decision = await openConfirmSaveModal({name, count: items.length});
    if(decision.useAsCurrent && !decision.password){
      alert("Você escolheu usar como lista atual, mas não digitou a senha.");
      return;
    }

    setBusy(true, "Salvando coleção…");
    st.textContent = "Salvando…";
    try{
      const resp = await apiPost({action:"addCollection", name, items});
      if(resp.status !== "ok"){
        st.textContent = resp.erro || "Erro ao salvar.";
        alert(resp.erro || "Erro ao salvar.");
        return;
      }

      st.textContent = `OK — ${resp.inserted} itens gravados em "${resp.colecao}"`;

      // recarrega coleções
      await loadCollections();

      // Se escolheu usar como atual -> exporta usando esta coleção como base/corte
      if(decision.useAsCurrent){
        setBusy(true, "Gravando como COLEÇÃO ATUAL…");
        const exp = await apiPost({
          action:"exportCurrentPrices",
          password: decision.password,
          baseCollection: resp.colecao // base = coleção recém salva
        });

        if(exp.status === "ok"){
          alert(`Coleção salva e gravada como COLEÇÃO ATUAL! (${exp.exported} itens)`);
        } else {
          alert(`Coleção foi salva, mas NÃO exportou como COLEÇÃO ATUAL.\nMotivo: ${exp.erro || "erro"}`);
        }
      } else {
        alert("Coleção salva com sucesso!");
      }

    } finally {
      setBusy(false);
    }
  };

  // ======================
  // EXPORTAR COLEÇÃO ATUAL (drawer)
  // ======================
  document.getElementById('btnExport').onclick = async ()=>{
    const baseCollection = document.getElementById('exportBase').value; // vazio = última
    const password = document.getElementById('exportPass').value;
    const st = document.getElementById('exportStatus');

    if(!password){ alert("Digite a senha."); return; }

    setBusy(true, "Gravando COLEÇÃO ATUAL…");
    st.textContent = "Exportando…";
    try{
      const resp = await apiPost({action:"exportCurrentPrices", password, baseCollection});
      if(resp.status === "ok"){
        st.textContent = `OK — ${resp.exported} itens (base: ${resp.cutoff})`;
        alert("Exportação concluída!");
      } else {
        st.textContent = resp.erro || "Senha inválida / erro.";
        alert(resp.erro || "Erro.");
      }
    } finally {
      setBusy(false);
    }
  };

  // ======================
  // BUSCAR REFERÊNCIA
  // ======================
  document.getElementById('btnBuscarRef').onclick = async ()=>{
    const ref = document.getElementById('refInput').value.trim().toUpperCase();
    const status = document.getElementById('refStatus');
    if(!ref) return;

    setBusy(true, "Buscando referência…");
    status.textContent = "Buscando…";
    try{
      const res = await apiGet("searchReference", {ref});

      if(!res.items || !res.items.length){
        document.getElementById('refResumo').style.display='none';
        document.getElementById('refTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Nenhum dado encontrado.</div>';
        status.textContent='';
        return;
      }

      document.getElementById('refMax').textContent = fmtBR(res.max);
      document.getElementById('refMaxCols').textContent = (res.maxCollections||[]).join(', ') || '-';

      document.getElementById('refAtualPreco').textContent = res.atual ? fmtBR(res.atual.preco) : '-';
      document.getElementById('refAtualCol').textContent   = res.atual ? res.atual.colecao : '-';

      document.getElementById('refResumo').style.display='flex';

      const rows = res.items.map(i=>[i.coll, fmtBR(i.price)]);
      renderTable('refTabelaWrap', ["Coleção","Preço"], rows);

      status.textContent = '';
    } finally {
      setBusy(false);
    }
  };

  // ======================
  // COMPARAR COLEÇÕES (com filtros)
  // ======================
  async function runCompare(){
    const a = document.getElementById('collA').value;
    const b = document.getElementById('collB').value;
    const onlyChanged = document.getElementById('cmpOnlyChanged').checked;
    const onlyUp = document.getElementById('cmpOnlyUp').checked;
    const onlyDown = document.getElementById('cmpOnlyDown').checked;

    if(!a || !b) return;

    document.getElementById('cmpStatus').textContent = 'Comparando…';
    setBusy(true, "Comparando coleções…");
    try{
      let rows = await apiGet("compareCollections",{a,b});
      rows = rows || [];

      if(onlyChanged) rows = rows.filter(r => r.alterou);
      if(onlyUp) rows = rows.filter(r => r.direcao === "SUBIU");
      if(onlyDown) rows = rows.filter(r => r.direcao === "DESCEU");

      const body = rows.map(r => ([
        r.referencia,
        r.precoA==null ? '-' : fmtBR(r.precoA),
        r.precoB==null ? '-' : fmtBR(r.precoB),
        r.delta==null ? '-' : fmtBR(r.delta),
        badgeDirecao(r.direcao)
      ]));

      renderTable('cmpTabelaWrap', ["REF", `Preço (${a})`, `Preço (${b})`, "Δ", "Status"], body);
      document.getElementById('cmpStatus').textContent = rows.length + " itens";
    } finally {
      setBusy(false);
    }
  }

  document.getElementById('btnComparar').onclick = runCompare;
  document.getElementById('cmpOnlyChanged').onchange = runCompare;
  document.getElementById('cmpOnlyUp').onchange = runCompare;
  document.getElementById('cmpOnlyDown').onchange = runCompare;

  // ======================
  // MAX POR REFERÊNCIA
  // ======================
  document.getElementById('btnMax').onclick = async ()=>{
    const coll = document.getElementById('maxColl').value;
    const st = document.getElementById('maxStatus');

    st.textContent = "Gerando…";
    setBusy(true, "Calculando maiores preços…");
    try{
      const list = await apiGet("maxByReference",{colecao: coll});
      if(!list || !list.length){
        document.getElementById('maxTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Sem dados.</div>';
        st.textContent = "";
        return;
      }
      const rows = list.map(r=>[r.referencia, fmtBR(r.max)]);
      renderTable('maxTabelaWrap', ["Referência","MAX de valor"], rows);
      st.textContent = list.length + " refs";
    } finally {
      setBusy(false);
    }
  };

  // ======================
  // MATRIZ + filtro em tempo real
  // ======================
  document.getElementById('btnMatriz').onclick = async ()=>{
    const limit = document.getElementById('matLimit').value;
    const st = document.getElementById('matStatus');

    st.textContent = "Gerando…";
    setBusy(true, "Montando tabela…");
    try{
      const obj = await apiGet("matrix",{limit});
      if(!obj || !obj.rows || !obj.rows.length){
        document.getElementById('matTabelaWrap').innerHTML = '<div class="muted" style="margin-top:10px">Sem dados.</div>';
        st.textContent = "";
        return;
      }

      const rows = obj.rows.map(r=>r.map((v,i)=> i===0 ? v : (v==null ? '-' : fmtBR(v))));
      renderTable('matTabelaWrap', obj.header, rows);
      st.textContent = `${obj.rows.length} linhas`;

      // filtro tempo real
      document.getElementById('matSearch').oninput = ()=>{
        const term = document.getElementById('matSearch').value.trim().toLowerCase();
        const tbody = document.querySelector('#matTabelaWrap tbody');
        if(!tbody) return;

        [...tbody.querySelectorAll('tr')].forEach(tr=>{
          const ref = (tr.querySelector('td')?.textContent || "").toLowerCase();
          tr.style.display = (!term || ref.includes(term)) ? "" : "none";
        });
      };

    } finally {
      setBusy(false);
    }
  };
</script>

</body>
</html>
